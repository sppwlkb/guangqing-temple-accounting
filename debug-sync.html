<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯åŒæ­¥è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .step {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #5a6fd8; }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ©º é›²ç«¯åŒæ­¥è¨ºæ–·å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·æœƒé€æ­¥æª¢æŸ¥ä½ çš„é›²ç«¯åŒæ­¥é…ç½®ï¼Œæ‰¾å‡ºå•é¡Œæ‰€åœ¨ã€‚</p>
        
        <button class="btn" onclick="runFullDiagnosis()">ğŸš€ é–‹å§‹å®Œæ•´è¨ºæ–·</button>
        <button class="btn" onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
        
        <div id="results"></div>
        
        <div class="step">
            <h3>ğŸ“ è¨ºæ–·æ—¥èªŒ</h3>
            <pre id="debug-log">é»æ“Šã€Œé–‹å§‹å®Œæ•´è¨ºæ–·ã€ä¾†æª¢æŸ¥å•é¡Œ...</pre>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦è…³æœ¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="env-loader.js"></script>
    <script src="supabase-sync.js"></script>

    <script>
        let results = document.getElementById('results');
        let debugLog = document.getElementById('debug-log');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function addStep(title, status, content, details = '') {
            const step = document.createElement('div');
            step.className = `step ${status}`;
            
            const icon = status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'âš ï¸';
            step.innerHTML = `
                <h3>${icon} ${title}</h3>
                <div>${content}</div>
                ${details ? `<details><summary>è©³ç´°è³‡è¨Š</summary><pre>${details}</pre></details>` : ''}
            `;
            
            results.appendChild(step);
        }

        function clearResults() {
            results.innerHTML = '';
            debugLog.textContent = 'è¨ºæ–·çµæœå·²æ¸…é™¤ï¼Œæº–å‚™é‡æ–°æª¢æŸ¥...\n';
        }

        async function runFullDiagnosis() {
            clearResults();
            log('é–‹å§‹å®Œæ•´è¨ºæ–·...');
            
            // æ­¥é©Ÿ 1: æª¢æŸ¥åŸºç¤ç’°å¢ƒ
            await checkEnvironment();
            
            // æ­¥é©Ÿ 2: æª¢æŸ¥ Supabase SDK
            await checkSupabaseSDK();
            
            // æ­¥é©Ÿ 3: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
            await checkEnvironmentVariables();
            
            // æ­¥é©Ÿ 4: æ¸¬è©¦ Supabase é€£æ¥
            await testSupabaseConnection();
            
            // æ­¥é©Ÿ 5: æª¢æŸ¥åŒæ­¥æœå‹™
            await checkSyncService();
            
            // æ­¥é©Ÿ 6: æ¸¬è©¦å¯¦éš›åŒæ­¥
            await testActualSync();
            
            log('è¨ºæ–·å®Œæˆï¼');
        }

        async function checkEnvironment() {
            log('æ­¥é©Ÿ 1: æª¢æŸ¥åŸºç¤ç’°å¢ƒ...');
            
            try {
                const info = {
                    'User Agent': navigator.userAgent,
                    'ç•¶å‰åŸŸå': window.location.hostname,
                    'æ˜¯å¦ç‚º Netlify': window.location.hostname.includes('netlify'),
                    'ç¶²è·¯ç‹€æ…‹': navigator.onLine ? 'ç·šä¸Š' : 'é›¢ç·š',
                    'æœ¬åœ°å­˜å„²å¯ç”¨': typeof(Storage) !== 'undefined'
                };
                
                addStep('åŸºç¤ç’°å¢ƒæª¢æŸ¥', 'success', 
                    'ç€è¦½å™¨ç’°å¢ƒæ­£å¸¸', 
                    Object.entries(info).map(([k,v]) => `${k}: ${v}`).join('\n')
                );
                
                log('âœ… åŸºç¤ç’°å¢ƒæª¢æŸ¥é€šé');
            } catch (error) {
                addStep('åŸºç¤ç’°å¢ƒæª¢æŸ¥', 'error', `ç’°å¢ƒæª¢æŸ¥å¤±æ•—: ${error.message}`);
                log('âŒ åŸºç¤ç’°å¢ƒæª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function checkSupabaseSDK() {
            log('æ­¥é©Ÿ 2: æª¢æŸ¥ Supabase SDK...');
            
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK æœªè¼‰å…¥');
                }
                
                if (typeof window.supabase.createClient !== 'function') {
                    throw new Error('Supabase createClient æ–¹æ³•ä¸å¯ç”¨');
                }
                
                addStep('Supabase SDK', 'success', 'SDK å·²æ­£ç¢ºè¼‰å…¥');
                log('âœ… Supabase SDK æª¢æŸ¥é€šé');
            } catch (error) {
                addStep('Supabase SDK', 'error', `SDK è¼‰å…¥å¤±æ•—: ${error.message}`);
                log('âŒ Supabase SDK æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function checkEnvironmentVariables() {
            log('æ­¥é©Ÿ 3: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸...');
            
            try {
                // ç­‰å¾… env-loader è¼‰å…¥
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const envConfig = window.getEnvConfig ? window.getEnvConfig() : null;
                
                if (!envConfig) {
                    throw new Error('ç’°å¢ƒé…ç½®å‡½æ•¸æœªè¼‰å…¥');
                }
                
                const details = {
                    'Supabase URL': envConfig.supabaseUrl || 'æœªè¨­å®š',
                    'Supabase Key': envConfig.supabaseKey ? 'å·²è¨­å®š (é•·åº¦: ' + envConfig.supabaseKey.length + ')' : 'æœªè¨­å®š',
                    'ç’°å¢ƒæ¨¡å¼': envConfig.environment || 'æœªçŸ¥',
                    'æ˜¯å¦ç”Ÿç”¢ç’°å¢ƒ': envConfig.isProduction ? 'æ˜¯' : 'å¦'
                };
                
                const isValid = envConfig.supabaseUrl && 
                               envConfig.supabaseKey && 
                               !envConfig.supabaseUrl.includes('your-project') &&
                               !envConfig.supabaseKey.includes('your-anon-key');
                
                if (isValid) {
                    addStep('ç’°å¢ƒè®Šæ•¸é…ç½®', 'success', 
                        'ç’°å¢ƒè®Šæ•¸å·²æ­£ç¢ºè¨­å®š', 
                        Object.entries(details).map(([k,v]) => `${k}: ${v}`).join('\n')
                    );
                    log('âœ… ç’°å¢ƒè®Šæ•¸æª¢æŸ¥é€šé');
                } else {
                    addStep('ç’°å¢ƒè®Šæ•¸é…ç½®', 'error', 
                        'ç’°å¢ƒè®Šæ•¸é…ç½®æœ‰å•é¡Œ', 
                        Object.entries(details).map(([k,v]) => `${k}: ${v}`).join('\n')
                    );
                    log('âŒ ç’°å¢ƒè®Šæ•¸é…ç½®æœ‰å•é¡Œ');
                }
            } catch (error) {
                addStep('ç’°å¢ƒè®Šæ•¸é…ç½®', 'error', `æª¢æŸ¥å¤±æ•—: ${error.message}`);
                log('âŒ ç’°å¢ƒè®Šæ•¸æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function testSupabaseConnection() {
            log('æ­¥é©Ÿ 4: æ¸¬è©¦ Supabase é€£æ¥...');
            
            try {
                const envConfig = window.getEnvConfig();
                if (!envConfig.supabaseUrl || !envConfig.supabaseKey) {
                    throw new Error('ç’°å¢ƒè®Šæ•¸æœªæ­£ç¢ºè¨­å®š');
                }
                
                const client = window.supabase.createClient(envConfig.supabaseUrl, envConfig.supabaseKey);
                log('æ­£åœ¨é€£æ¥ Supabase...');
                
                // æ¸¬è©¦é€£æ¥åˆ° temple_data è³‡æ–™è¡¨
                const { data, error } = await client
                    .from('temple_data')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    const details = `éŒ¯èª¤ä»£ç¢¼: ${error.code || 'ç„¡'}
éŒ¯èª¤è¨Šæ¯: ${error.message}
éŒ¯èª¤è©³æƒ…: ${error.details || 'ç„¡'}
æç¤º: ${error.hint || 'ç„¡'}`;
                    
                    addStep('Supabase é€£æ¥æ¸¬è©¦', 'error', 
                        `é€£æ¥å¤±æ•—: ${error.message}`, 
                        details
                    );
                    log('âŒ Supabase é€£æ¥å¤±æ•—: ' + error.message);
                } else {
                    addStep('Supabase é€£æ¥æ¸¬è©¦', 'success', 
                        'æˆåŠŸé€£æ¥åˆ°è³‡æ–™åº«', 
                        `æŸ¥è©¢çµæœ: ${JSON.stringify(data, null, 2)}`
                    );
                    log('âœ… Supabase é€£æ¥æ¸¬è©¦é€šé');
                }
            } catch (error) {
                addStep('Supabase é€£æ¥æ¸¬è©¦', 'error', `æ¸¬è©¦å¤±æ•—: ${error.message}`);
                log('âŒ Supabase é€£æ¥æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        async function checkSyncService() {
            log('æ­¥é©Ÿ 5: æª¢æŸ¥åŒæ­¥æœå‹™...');
            
            try {
                if (!window.supabaseSync) {
                    throw new Error('SupabaseSync æœå‹™æœªåˆå§‹åŒ–');
                }
                
                const status = window.supabaseSync.getSyncStatus();
                
                const details = {
                    'è¨­å‚™ ID': status.deviceId,
                    'ç¶²è·¯ç‹€æ…‹': status.isOnline ? 'ç·šä¸Š' : 'é›¢ç·š',
                    'æœ€å¾ŒåŒæ­¥æ™‚é–“': status.lastSyncTime,
                    'æœå‹™æä¾›å•†': status.provider,
                    'åŒæ­¥é€²è¡Œä¸­': status.syncInProgress ? 'æ˜¯' : 'å¦'
                };
                
                addStep('åŒæ­¥æœå‹™æª¢æŸ¥', 'success', 
                    'åŒæ­¥æœå‹™å·²æ­£ç¢ºè¼‰å…¥', 
                    Object.entries(details).map(([k,v]) => `${k}: ${v}`).join('\n')
                );
                log('âœ… åŒæ­¥æœå‹™æª¢æŸ¥é€šé');
            } catch (error) {
                addStep('åŒæ­¥æœå‹™æª¢æŸ¥', 'error', `æª¢æŸ¥å¤±æ•—: ${error.message}`);
                log('âŒ åŒæ­¥æœå‹™æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function testActualSync() {
            log('æ­¥é©Ÿ 6: æ¸¬è©¦å¯¦éš›åŒæ­¥åŠŸèƒ½...');
            
            try {
                if (!window.supabaseSync) {
                    throw new Error('åŒæ­¥æœå‹™ä¸å¯ç”¨');
                }
                
                log('æ­£åœ¨ç”Ÿæˆæ¸¬è©¦è³‡æ–™...');
                
                // ç”Ÿæˆä¸€ç­†æ¸¬è©¦è³‡æ–™
                const testRecord = {
                    id: 'test_' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    type: 'æ”¶å…¥',
                    category: 'æ¸¬è©¦è³‡æ–™',
                    amount: 100,
                    description: 'è¨ºæ–·å·¥å…·æ¸¬è©¦è³‡æ–™',
                    timestamp: Date.now()
                };
                
                // å„²å­˜åˆ°æœ¬åœ°
                const existingRecords = JSON.parse(localStorage.getItem('temple-records') || '[]');
                existingRecords.push(testRecord);
                localStorage.setItem('temple-records', JSON.stringify(existingRecords));
                localStorage.setItem('temple-last-modified', Date.now().toString());
                
                log('æ­£åœ¨æ¸¬è©¦ä¸Šå‚³åˆ°é›²ç«¯...');
                
                const syncResult = await window.supabaseSync.syncToCloud();
                
                if (syncResult.success) {
                    addStep('å¯¦éš›åŒæ­¥æ¸¬è©¦', 'success', 
                        'åŒæ­¥æ¸¬è©¦æˆåŠŸï¼', 
                        `æä¾›å•†: ${syncResult.provider}
åŒæ­¥æ™‚é–“: ${syncResult.syncTime}
è¨­å‚™ ID: ${syncResult.deviceId || 'ç„¡'}
è¨Šæ¯: ${syncResult.message}`
                    );
                    log('âœ… å¯¦éš›åŒæ­¥æ¸¬è©¦æˆåŠŸ');
                    
                    // æ¸…ç†æ¸¬è©¦è³‡æ–™
                    const cleanRecords = existingRecords.filter(r => r.id !== testRecord.id);
                    localStorage.setItem('temple-records', JSON.stringify(cleanRecords));
                    log('ğŸ§¹ æ¸¬è©¦è³‡æ–™å·²æ¸…ç†');
                    
                } else {
                    addStep('å¯¦éš›åŒæ­¥æ¸¬è©¦', 'error', 
                        `åŒæ­¥å¤±æ•—: ${syncResult.message}`, 
                        JSON.stringify(syncResult, null, 2)
                    );
                    log('âŒ å¯¦éš›åŒæ­¥æ¸¬è©¦å¤±æ•—: ' + syncResult.message);
                }
            } catch (error) {
                addStep('å¯¦éš›åŒæ­¥æ¸¬è©¦', 'error', 
                    `æ¸¬è©¦å¤±æ•—: ${error.message}`, 
                    error.stack || 'ç„¡å †ç–Šè³‡è¨Š'
                );
                log('âŒ å¯¦éš›åŒæ­¥æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        // è‡ªå‹•é–‹å§‹è¨ºæ–·
        document.addEventListener('DOMContentLoaded', function() {
            log('è¨ºæ–·å·¥å…·å·²è¼‰å…¥');
            setTimeout(() => {
                log('3ç§’å¾Œè‡ªå‹•é–‹å§‹è¨ºæ–·...');
                setTimeout(runFullDiagnosis, 3000);
            }, 1000);
        });
    </script>
</body>
</html>