<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯åŒæ­¥å®Œæ•´æ¸¬è©¦ - å»£æ¸…å®®è¨˜å¸³è»Ÿé«”</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        .test-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .test-section.success { border-left-color: #28a745; background: linear-gradient(135deg, #d4edda, #c3e6cb); }
        .test-section.error { border-left-color: #dc3545; background: linear-gradient(135deg, #f8d7da, #f5c6cb); }
        .test-section.warning { border-left-color: #ffc107; background: linear-gradient(135deg, #fff3cd, #ffeeba); }
        .test-section.info { border-left-color: #17a2b8; background: linear-gradient(135deg, #d1ecf1, #bee5eb); }
        .test-section.running { border-left-color: #6f42c1; background: linear-gradient(135deg, #e2d9f3, #d4cce8); }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        .btn-success:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
        }
        
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 10px; 
        }
        h3 { 
            margin-top: 0; 
            display: flex; 
            align-items: center; 
        }
        .icon { 
            font-size: 1.5em; 
            margin-right: 10px; 
        }
        
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin-top: 5px;
        }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-loading { background: #ffc107; color: #000; }
        .status-success { background: #17a2b8; }
        
        .results-container {
            max-height: 600px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .test-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .test-controls { flex-direction: column; align-items: center; }
            .btn { margin: 5px 0; width: 200px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ é›²ç«¯åŒæ­¥å®Œæ•´æ¸¬è©¦å·¥å…·</h1>
            <p>å»£æ¸…å®®è¨˜å¸³è»Ÿé«” - Supabase é›²ç«¯åŒæ­¥åŠŸèƒ½æª¢æ¸¬</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>
        
        <div class="status-grid">
            <div class="status-item">
                <strong>ç¶²è·¯ç‹€æ…‹</strong>
                <div class="status-badge status-loading" id="network-status">æª¢æŸ¥ä¸­</div>
            </div>
            <div class="status-item">
                <strong>Supabase SDK</strong>
                <div class="status-badge status-loading" id="sdk-status">è¼‰å…¥ä¸­</div>
            </div>
            <div class="status-item">
                <strong>è³‡æ–™åº«é€£æ¥</strong>
                <div class="status-badge status-loading" id="db-status">æ¸¬è©¦ä¸­</div>
            </div>
            <div class="status-item">
                <strong>åŒæ­¥æœå‹™</strong>
                <div class="status-badge status-loading" id="sync-status">åˆå§‹åŒ–ä¸­</div>
            </div>
        </div>
        
        <div class="test-controls">
            <button class="btn" onclick="runFullTest()" id="fullTestBtn">ğŸ” å®Œæ•´è¨ºæ–·</button>
            <button class="btn btn-success" onclick="testUpload()" id="uploadBtn" disabled>ğŸ“¤ æ¸¬è©¦ä¸Šå‚³</button>
            <button class="btn btn-success" onclick="testDownload()" id="downloadBtn" disabled>ğŸ“¥ æ¸¬è©¦ä¸‹è¼‰</button>
            <button class="btn btn-warning" onclick="stressTest()" id="stressBtn" disabled>âš¡ å£“åŠ›æ¸¬è©¦</button>
            <button class="btn btn-danger" onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
        </div>
        
        <div class="stats-display" id="statsDisplay" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="testCount">0</div>
                <div class="stat-label">å·²åŸ·è¡Œæ¸¬è©¦</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">æˆåŠŸæ¬¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">éŒ¯èª¤æ¬¡æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgTime">0ms</div>
                <div class="stat-label">å¹³å‡æ™‚é–“</div>
            </div>
        </div>
        
        <div class="results-container">
            <div id="results"></div>
        </div>
        
        <div class="test-section info">
            <h3><span class="icon">ğŸ“</span> æ¸¬è©¦æ—¥èªŒ</h3>
            <pre id="debug-log">ç­‰å¾…æ¸¬è©¦é–‹å§‹...</pre>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦è…³æœ¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="env-loader.js"></script>
    <script src="supabase-sync-final.js"></script>

    <script>
        let results = document.getElementById('results');
        let debugLog = document.getElementById('debug-log');
        let progress = document.getElementById('progress');
        let currentProgress = 0;
        
        // çµ±è¨ˆè®Šæ•¸
        let testStats = {
            total: 0,
            success: 0,
            error: 0,
            times: []
        };

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }

        function updateProgress(percent) {
            currentProgress = Math.min(100, Math.max(0, percent));
            progress.style.width = currentProgress + '%';
        }

        function updateStatus(element, status, text) {
            const statusElement = document.getElementById(element);
            statusElement.className = `status-badge status-${status}`;
            statusElement.textContent = text;
        }

        function addTestResult(title, status, content, details = '', duration = null) {
            const icons = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸',
                'running': 'â³'
            };
            
            const section = document.createElement('div');
            section.className = `test-section ${status}`;
            
            const durationText = duration ? ` (${duration}ms)` : '';
            section.innerHTML = `
                <h3><span class="icon">${icons[status]}</span> ${title}${durationText}</h3>
                <div>${content}</div>
                ${details ? `<details style="margin-top: 10px;"><summary style="cursor: pointer;">è©³ç´°è³‡è¨Š</summary><pre style="margin-top: 10px;">${details}</pre></details>` : ''}
            `;
            
            results.appendChild(section);
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // æ›´æ–°çµ±è¨ˆ
            testStats.total++;
            if (status === 'success') testStats.success++;
            if (status === 'error') testStats.error++;
            if (duration) testStats.times.push(duration);
            updateStats();
        }

        function updateStats() {
            document.getElementById('testCount').textContent = testStats.total;
            document.getElementById('successCount').textContent = testStats.success;
            document.getElementById('errorCount').textContent = testStats.error;
            
            if (testStats.times.length > 0) {
                const avgTime = Math.round(testStats.times.reduce((a, b) => a + b, 0) / testStats.times.length);
                document.getElementById('avgTime').textContent = avgTime + 'ms';
            }
            
            document.getElementById('statsDisplay').style.display = 'grid';
        }

        function clearResults() {
            results.innerHTML = '';
            debugLog.textContent = 'çµæœå·²æ¸…é™¤ï¼Œæº–å‚™é‡æ–°æ¸¬è©¦...\n';
            updateProgress(0);
            testStats = { total: 0, success: 0, error: 0, times: [] };
            updateStats();
        }

        async function runFullTest() {
            clearResults();
            log('ğŸš€ é–‹å§‹å®Œæ•´è¨ºæ–·æ¸¬è©¦...');
            updateProgress(0);
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            ['uploadBtn', 'downloadBtn', 'stressBtn'].forEach(id => {
                document.getElementById(id).disabled = true;
            });

            // é‡ç½®åŒæ­¥ç‹€æ…‹
            if (window.supabaseSync && window.supabaseSync.syncInProgress) {
                log('é‡ç½®åŒæ­¥ç‹€æ…‹...');
                window.supabaseSync.syncInProgress = false;
            }

            try {
                // æ¸¬è©¦ 1: ç¶²è·¯ç‹€æ…‹ (10%)
                await testNetworkStatus();
                updateProgress(10);

                // æ¸¬è©¦ 2: SDK è¼‰å…¥ (25%)
                await testSDKLoading();
                updateProgress(25);

                // æ¸¬è©¦ 3: ç’°å¢ƒè®Šæ•¸ (40%)
                await testEnvironmentConfig();
                updateProgress(40);

                // æ¸¬è©¦ 4: è³‡æ–™åº«é€£æ¥ (60%)
                await testDatabaseConnection();
                updateProgress(60);

                // æ¸¬è©¦ 5: åŒæ­¥æœå‹™ (80%)
                await testSyncService();
                updateProgress(80);

                // æ¸¬è©¦ 6: å®Œæ•´åŠŸèƒ½ (100%)
                await testCompleteFunctionality();
                updateProgress(100);

                // å•Ÿç”¨åŠŸèƒ½æŒ‰éˆ•
                if (window.supabaseSync && window.supabaseSync.getSyncStatus().initialized) {
                    ['uploadBtn', 'downloadBtn', 'stressBtn'].forEach(id => {
                        document.getElementById(id).disabled = false;
                    });
                }

                log('ğŸ‰ å®Œæ•´è¨ºæ–·æ¸¬è©¦å®Œæˆï¼');
                addTestResult('è¨ºæ–·å®Œæˆ', 'success', 'æ‰€æœ‰æ¸¬è©¦å·²åŸ·è¡Œå®Œç•¢ï¼Œè«‹æŸ¥çœ‹å„é …çµæœ');

            } catch (error) {
                log('âŒ è¨ºæ–·æ¸¬è©¦å¤±æ•—: ' + error.message);
                addTestResult('è¨ºæ–·å¤±æ•—', 'error', `æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }

        async function testNetworkStatus() {
            const startTime = Date.now();
            log('æ­¥é©Ÿ 1/6: æª¢æŸ¥ç¶²è·¯ç‹€æ…‹...');
            
            try {
                const isOnline = navigator.onLine;
                updateStatus('network-status', isOnline ? 'online' : 'offline', isOnline ? 'ç·šä¸Š' : 'é›¢ç·š');
                
                // æ¸¬è©¦å¯¦éš›ç¶²è·¯é€£æ¥
                const response = await fetch('https://httpbin.org/get', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                const duration = Date.now() - startTime;
                if (response.ok) {
                    addTestResult('ç¶²è·¯é€£æ¥æ¸¬è©¦', 'success', 'ç¶²è·¯é€£æ¥æ­£å¸¸ï¼Œå¯ä»¥é€²è¡Œé›²ç«¯åŒæ­¥', '', duration);
                    log('âœ… ç¶²è·¯ç‹€æ…‹æª¢æŸ¥é€šé');
                } else {
                    throw new Error('ç¶²è·¯é€£æ¥ç•°å¸¸');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                updateStatus('network-status', 'offline', 'é›¢ç·š');
                addTestResult('ç¶²è·¯é€£æ¥æ¸¬è©¦', 'error', `ç¶²è·¯é€£æ¥å¤±æ•—: ${error.message}`, '', duration);
                log('âŒ ç¶²è·¯ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ' + error.message);
                throw error;
            }
        }

        async function testSDKLoading() {
            const startTime = Date.now();
            log('æ­¥é©Ÿ 2/6: æª¢æŸ¥ Supabase SDK...');
            
            try {
                // ç­‰å¾… SDK è¼‰å…¥
                let attempts = 0;
                while (!window.supabase && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                const duration = Date.now() - startTime;
                if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
                    updateStatus('sdk-status', 'success', 'å·²è¼‰å…¥');
                    addTestResult('Supabase SDK', 'success', 'SDK è¼‰å…¥æˆåŠŸï¼Œç‰ˆæœ¬æ­£ç¢º', '', duration);
                    log('âœ… Supabase SDK æª¢æŸ¥é€šé');
                } else {
                    throw new Error('SDK è¼‰å…¥å¤±æ•—æˆ–ç‰ˆæœ¬ä¸ç›¸å®¹');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                updateStatus('sdk-status', 'offline', 'è¼‰å…¥å¤±æ•—');
                addTestResult('Supabase SDK', 'error', `SDK è¼‰å…¥å¤±æ•—: ${error.message}`, '', duration);
                log('âŒ Supabase SDK æª¢æŸ¥å¤±æ•—: ' + error.message);
                throw error;
            }
        }

        async function testEnvironmentConfig() {
            const startTime = Date.now();
            log('æ­¥é©Ÿ 3/6: æª¢æŸ¥ç’°å¢ƒé…ç½®...');
            
            try {
                const envCheck = window.checkEnvironment();
                const duration = Date.now() - startTime;
                
                if (envCheck.ready) {
                    addTestResult(
                        'ç’°å¢ƒé…ç½®æª¢æŸ¥', 
                        'success', 
                        'ç’°å¢ƒè®Šæ•¸é…ç½®æ­£ç¢º',
                        `URL: ${envCheck.config.supabaseUrl}\nKey: å·²è¨­å®š (${envCheck.config.supabaseKey.length} å­—å…ƒ)\nç’°å¢ƒ: ${envCheck.config.environment}`,
                        duration
                    );
                    log('âœ… ç’°å¢ƒé…ç½®æª¢æŸ¥é€šé');
                } else {
                    addTestResult(
                        'ç’°å¢ƒé…ç½®æª¢æŸ¥', 
                        'warning', 
                        'ç’°å¢ƒé…ç½®æœ‰å•é¡Œï¼Œä½†å¯èƒ½ä»èƒ½é‹ä½œ',
                        `è­¦å‘Š: ${envCheck.warnings.join(', ')}`,
                        duration
                    );
                    log('âš ï¸ ç’°å¢ƒé…ç½®æœ‰è­¦å‘Š: ' + envCheck.warnings.join(', '));
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('ç’°å¢ƒé…ç½®æª¢æŸ¥', 'error', `é…ç½®æª¢æŸ¥å¤±æ•—: ${error.message}`, '', duration);
                log('âŒ ç’°å¢ƒé…ç½®æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function testDatabaseConnection() {
            const startTime = Date.now();
            log('æ­¥é©Ÿ 4/6: æ¸¬è©¦è³‡æ–™åº«é€£æ¥...');
            
            try {
                const client = window.supabase.createClient(
                    'https://nfncwofzfjdvyhdfjbzw.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mbmN3b2Z6ZmpkdnloZGZqYnp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MjM0MDcsImV4cCI6MjA3MzA5OTQwN30.ZyLtV91pG618utDhJhGJbZpbFPZ_IEx2mBPc7GVfkH4'
                );

                const { data, error } = await Promise.race([
                    client.from('temple_data').select('count').limit(1),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('é€£æ¥è¶…æ™‚')), 10000)
                    )
                ]);

                const duration = Date.now() - startTime;
                if (error) {
                    updateStatus('db-status', 'offline', 'é€£æ¥å¤±æ•—');
                    
                    let errorMessage = error.message;
                    let suggestion = '';
                    
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        suggestion = 'è«‹åœ¨ Supabase æ§åˆ¶å°åŸ·è¡Œ supabase-setup-optimized.sql è…³æœ¬å»ºç«‹è³‡æ–™è¡¨';
                        errorMessage = 'è³‡æ–™è¡¨ temple_data ä¸å­˜åœ¨';
                    } else if (error.message.includes('permission') || error.message.includes('policy')) {
                        suggestion = 'è«‹æª¢æŸ¥ RLS æ¬Šé™æ”¿ç­–è¨­å®š';
                        errorMessage = 'æ¬Šé™æ”¿ç­–å•é¡Œ';
                    }
                    
                    addTestResult(
                        'è³‡æ–™åº«é€£æ¥æ¸¬è©¦', 
                        'error', 
                        errorMessage,
                        `éŒ¯èª¤è©³æƒ…: ${JSON.stringify(error, null, 2)}\n\nè§£æ±ºå»ºè­°: ${suggestion}`,
                        duration
                    );
                    log('âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—: ' + errorMessage);
                } else {
                    updateStatus('db-status', 'success', 'é€£æ¥æˆåŠŸ');
                    addTestResult(
                        'è³‡æ–™åº«é€£æ¥æ¸¬è©¦', 
                        'success', 
                        'æˆåŠŸé€£æ¥åˆ° Supabase è³‡æ–™åº«',
                        `æŸ¥è©¢çµæœ: ${JSON.stringify(data, null, 2)}`,
                        duration
                    );
                    log('âœ… è³‡æ–™åº«é€£æ¥æ¸¬è©¦é€šé');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                updateStatus('db-status', 'offline', 'æ¸¬è©¦å¤±æ•—');
                addTestResult('è³‡æ–™åº«é€£æ¥æ¸¬è©¦', 'error', `é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, '', duration);
                log('âŒ è³‡æ–™åº«é€£æ¥æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        async function testSyncService() {
            const startTime = Date.now();
            log('æ­¥é©Ÿ 5/6: æª¢æŸ¥åŒæ­¥æœå‹™...');
            
            try {
                // ç­‰å¾…åŒæ­¥æœå‹™åˆå§‹åŒ–
                let attempts = 0;
                while (!window.supabaseSync && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.supabaseSync) {
                    throw new Error('åŒæ­¥æœå‹™æœªè¼‰å…¥');
                }
                
                // ç­‰å¾…æœå‹™åˆå§‹åŒ–å®Œæˆ
                await window.supabaseSync.initPromise;
                
                const status = window.supabaseSync.getSyncStatus();
                const duration = Date.now() - startTime;
                
                if (status.initialized) {
                    updateStatus('sync-status', 'success', 'æœå‹™æ­£å¸¸');
                    addTestResult(
                        'åŒæ­¥æœå‹™æª¢æŸ¥', 
                        'success', 
                        'åŒæ­¥æœå‹™è¼‰å…¥ä¸¦åˆå§‹åŒ–æˆåŠŸ',
                        `è¨­å‚™ ID: ${status.deviceId}\nç¶²è·¯ç‹€æ…‹: ${status.isOnline ? 'ç·šä¸Š' : 'é›¢ç·š'}\næä¾›å•†: ${status.provider}\næœ€å¾ŒåŒæ­¥: ${status.lastSyncTime}`,
                        duration
                    );
                    log('âœ… åŒæ­¥æœå‹™æª¢æŸ¥é€šé');
                } else {
                    updateStatus('sync-status', 'offline', 'åˆå§‹åŒ–å¤±æ•—');
                    addTestResult(
                        'åŒæ­¥æœå‹™æª¢æŸ¥', 
                        'warning', 
                        'åŒæ­¥æœå‹™è¼‰å…¥ä½†åˆå§‹åŒ–å¯èƒ½æœ‰å•é¡Œ',
                        `ç‹€æ…‹è©³æƒ…: ${JSON.stringify(status, null, 2)}`,
                        duration
                    );
                    log('âš ï¸ åŒæ­¥æœå‹™å¯èƒ½æœ‰å•é¡Œ');
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                updateStatus('sync-status', 'offline', 'è¼‰å…¥å¤±æ•—');
                addTestResult('åŒæ­¥æœå‹™æª¢æŸ¥', 'error', `æœå‹™æª¢æŸ¥å¤±æ•—: ${error.message}`, '', duration);
                log('âŒ åŒæ­¥æœå‹™æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function testCompleteFunctionality() {
            const startTime = Date.now();
            log('æ­¥é©Ÿ 6/6: æ¸¬è©¦å®Œæ•´åŠŸèƒ½...');
            
            try {
                if (!window.supabaseSync) {
                    throw new Error('åŒæ­¥æœå‹™ä¸å¯ç”¨');
                }
                
                // é‡ç½®åŒæ­¥ç‹€æ…‹
                if (window.supabaseSync.syncInProgress) {
                    log('é‡ç½®åŒæ­¥ç‹€æ…‹...');
                    window.supabaseSync.syncInProgress = false;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
                const testRecord = {
                    id: 'complete_test_' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    type: 'æ”¶å…¥',
                    category: 'å®Œæ•´æ¸¬è©¦',
                    amount: 888,
                    description: 'å®Œæ•´åŠŸèƒ½æ¸¬è©¦æ•¸æ“š',
                    timestamp: Date.now()
                };
                
                // æ·»åŠ åˆ°æœ¬åœ°å­˜å„²
                const records = JSON.parse(localStorage.getItem('temple-records') || '[]');
                records.push(testRecord);
                localStorage.setItem('temple-records', JSON.stringify(records));
                localStorage.setItem('temple-last-modified', Date.now().toString());
                
                log('æ­£åœ¨åŸ·è¡Œä¸Šå‚³åŒæ­¥æ¸¬è©¦...');
                const syncResult = await window.supabaseSync.syncToCloud();
                
                const duration = Date.now() - startTime;
                if (syncResult.success) {
                    addTestResult(
                        'å®Œæ•´åŠŸèƒ½æ¸¬è©¦', 
                        'success', 
                        'ğŸ‰ é›²ç«¯åŒæ­¥åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼',
                        `æ¸¬è©¦çµæœ:\nâ€¢ æä¾›å•†: ${syncResult.provider}\nâ€¢ åŒæ­¥æ™‚é–“: ${syncResult.syncTime}\nâ€¢ è¨˜éŒ„æ•¸: ${syncResult.recordsCount}\nâ€¢ ä¿¡çœ¾æ•¸: ${syncResult.believersCount}\nâ€¢ è¨­å‚™ ID: ${syncResult.deviceId}\nâ€¢ æ“ä½œ: ${syncResult.action || 'åŒæ­¥'}\nâ€¢ è¨Šæ¯: ${syncResult.message}`,
                        duration
                    );
                    log('ğŸ‰ å®Œæ•´åŠŸèƒ½æ¸¬è©¦æˆåŠŸï¼');
                    
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    const cleanRecords = records.filter(r => r.id !== testRecord.id);
                    localStorage.setItem('temple-records', JSON.stringify(cleanRecords));
                    log('ğŸ§¹ æ¸¬è©¦æ•¸æ“šå·²æ¸…ç†');
                } else {
                    addTestResult(
                        'å®Œæ•´åŠŸèƒ½æ¸¬è©¦', 
                        'error', 
                        `åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${syncResult.message}`,
                        JSON.stringify(syncResult, null, 2),
                        duration
                    );
                    log('âŒ å®Œæ•´åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ' + syncResult.message);
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult(
                    'å®Œæ•´åŠŸèƒ½æ¸¬è©¦', 
                    'error', 
                    `æ¸¬è©¦å¤±æ•—: ${error.message}`,
                    error.stack || 'ç„¡å †ç–Šè³‡è¨Š',
                    duration
                );
                log('âŒ å®Œæ•´åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        async function testUpload() {
            if (!window.supabaseSync) {
                alert('âŒ åŒæ­¥æœå‹™ä¸å¯ç”¨');
                return;
            }
            
            const startTime = Date.now();
            log('ğŸ“¤ é–‹å§‹ä¸Šå‚³æ¸¬è©¦...');
            
            try {
                const result = await window.supabaseSync.syncToCloud();
                const duration = Date.now() - startTime;
                
                if (result.success) {
                    addTestResult(
                        'ä¸Šå‚³æ¸¬è©¦',
                        'success',
                        'ä¸Šå‚³æˆåŠŸï¼',
                        JSON.stringify(result, null, 2),
                        duration
                    );
                    alert('âœ… ä¸Šå‚³æ¸¬è©¦æˆåŠŸï¼');
                } else {
                    addTestResult('ä¸Šå‚³æ¸¬è©¦', 'error', `ä¸Šå‚³å¤±æ•—: ${result.message}`, '', duration);
                    alert('âŒ ä¸Šå‚³æ¸¬è©¦å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('ä¸Šå‚³æ¸¬è©¦', 'error', `ä¸Šå‚³å¤±æ•—: ${error.message}`, '', duration);
                alert('âŒ ä¸Šå‚³æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        async function testDownload() {
            if (!window.supabaseSync) {
                alert('âŒ åŒæ­¥æœå‹™ä¸å¯ç”¨');
                return;
            }
            
            const startTime = Date.now();
            log('ğŸ“¥ é–‹å§‹ä¸‹è¼‰æ¸¬è©¦...');
            
            try {
                const result = await window.supabaseSync.syncFromCloud();
                const duration = Date.now() - startTime;
                
                if (result.success) {
                    addTestResult(
                        'ä¸‹è¼‰æ¸¬è©¦',
                        'success',
                        'ä¸‹è¼‰æˆåŠŸï¼',
                        JSON.stringify(result, null, 2),
                        duration
                    );
                    alert('âœ… ä¸‹è¼‰æ¸¬è©¦æˆåŠŸï¼');
                } else {
                    addTestResult('ä¸‹è¼‰æ¸¬è©¦', 'error', `ä¸‹è¼‰å¤±æ•—: ${result.message}`, '', duration);
                    alert('âŒ ä¸‹è¼‰æ¸¬è©¦å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                addTestResult('ä¸‹è¼‰æ¸¬è©¦', 'error', `ä¸‹è¼‰å¤±æ•—: ${error.message}`, '', duration);
                alert('âŒ ä¸‹è¼‰æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        async function stressTest() {
            if (!window.supabaseSync) {
                alert('âŒ åŒæ­¥æœå‹™ä¸å¯ç”¨');
                return;
            }
            
            const iterations = 5;
            log(`âš¡ é–‹å§‹å£“åŠ›æ¸¬è©¦ (${iterations} æ¬¡)...`);
            
            let successCount = 0;
            let failCount = 0;
            const times = [];
            
            for (let i = 1; i <= iterations; i++) {
                try {
                    const startTime = Date.now();
                    log(`åŸ·è¡Œç¬¬ ${i}/${iterations} æ¬¡æ¸¬è©¦...`);
                    
                    const result = await window.supabaseSync.syncToCloud();
                    const duration = Date.now() - startTime;
                    times.push(duration);
                    
                    if (result.success) {
                        successCount++;
                        log(`âœ… ç¬¬ ${i} æ¬¡æ¸¬è©¦æˆåŠŸ (${duration}ms)`);
                    } else {
                        failCount++;
                        log(`âŒ ç¬¬ ${i} æ¬¡æ¸¬è©¦å¤±æ•—: ${result.message}`);
                    }
                    
                    // çŸ­æš«å»¶é²é¿å…éåº¦é »ç¹è«‹æ±‚
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    failCount++;
                    log(`âŒ ç¬¬ ${i} æ¬¡æ¸¬è©¦ç•°å¸¸: ${error.message}`);
                }
            }
            
            const avgTime = times.length > 0 ? Math.round(times.reduce((a, b) => a + b, 0) / times.length) : 0;
            const successRate = Math.round((successCount / iterations) * 100);
            
            addTestResult(
                'å£“åŠ›æ¸¬è©¦',
                successRate >= 80 ? 'success' : successRate >= 60 ? 'warning' : 'error',
                `å£“åŠ›æ¸¬è©¦å®Œæˆï¼æˆåŠŸç‡: ${successRate}%`,
                `ç¸½æ¸¬è©¦æ¬¡æ•¸: ${iterations}\næˆåŠŸæ¬¡æ•¸: ${successCount}\nå¤±æ•—æ¬¡æ•¸: ${failCount}\nå¹³å‡æ™‚é–“: ${avgTime}ms\næˆåŠŸç‡: ${successRate}%`
            );
            
            alert(`âš¡ å£“åŠ›æ¸¬è©¦å®Œæˆï¼\næˆåŠŸç‡: ${successRate}%\nå¹³å‡æ™‚é–“: ${avgTime}ms`);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•é–‹å§‹æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            
            // æª¢æŸ¥åŸºæœ¬ç¶²è·¯ç‹€æ…‹
            updateStatus('network-status', navigator.onLine ? 'online' : 'offline', 
                        navigator.onLine ? 'ç·šä¸Š' : 'é›¢ç·š');
            
            // 3ç§’å¾Œè‡ªå‹•é–‹å§‹å®Œæ•´æ¸¬è©¦
            setTimeout(() => {
                log('â° 3ç§’å¾Œè‡ªå‹•é–‹å§‹å®Œæ•´æ¸¬è©¦...');
                setTimeout(runFullTest, 3000);
            }, 1000);
        });

        // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
        window.addEventListener('online', () => {
            log('ğŸŒ ç¶²è·¯å·²é€£æ¥');
            updateStatus('network-status', 'online', 'ç·šä¸Š');
        });
        
        window.addEventListener('offline', () => {
            log('ğŸ“´ ç¶²è·¯å·²æ–·ç·š');
            updateStatus('network-status', 'offline', 'é›¢ç·š');
        });
    </script>
</body>
</html>