<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€çµ‚æ¸¬è©¦ - é›²ç«¯åŒæ­¥</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .test-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .success { border-left-color: #28a745; background: linear-gradient(135deg, #d4edda, #c3e6cb); }
        .error { border-left-color: #dc3545; background: linear-gradient(135deg, #f8d7da, #f5c6cb); }
        .warning { border-left-color: #ffc107; background: linear-gradient(135deg, #fff3cd, #ffeeba); }
        .info { border-left-color: #17a2b8; background: linear-gradient(135deg, #d1ecf1, #bee5eb); }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        h3 { margin-top: 0; display: flex; align-items: center; }
        .icon { font-size: 1.5em; margin-right: 10px; }
        
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-loading { background: #ffc107; color: #000; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å»£æ¸…å®®è¨˜å¸³è»Ÿé«” - æœ€çµ‚åŒæ­¥æ¸¬è©¦</h1>
        
        <div class="test-card info">
            <h3><span class="icon">â„¹ï¸</span> æ¸¬è©¦èªªæ˜</h3>
            <p>é€™æ˜¯å…¨æ–°çš„ v2.0 ç‰ˆæœ¬ï¼Œä¸æœƒå—åˆ°èˆŠç‰ˆå¿«å–å½±éŸ¿ã€‚å°‡é€²è¡Œå®Œæ•´çš„é›²ç«¯åŒæ­¥æ¸¬è©¦ã€‚</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="runFullTest()">ğŸ”¥ é–‹å§‹æœ€çµ‚æ¸¬è©¦</button>
            <button class="btn btn-success" onclick="testQuickSync()" id="syncBtn" disabled>âš¡ å¿«é€ŸåŒæ­¥æ¸¬è©¦</button>
        </div>
        
        <div id="results"></div>
        
        <div class="test-card">
            <h3><span class="icon">ğŸ“Š</span> å³æ™‚ç‹€æ…‹</h3>
            <div id="live-status">
                ç¶²è·¯: <span class="status-badge status-loading">æª¢æŸ¥ä¸­</span>
                Supabase: <span class="status-badge status-loading">æª¢æŸ¥ä¸­</span>
                åŒæ­¥æœå‹™: <span class="status-badge status-loading">æª¢æŸ¥ä¸­</span>
            </div>
        </div>
        
        <div class="test-card">
            <h3><span class="icon">ğŸ“</span> æ¸¬è©¦æ—¥èªŒ</h3>
            <pre id="debug-log">ç­‰å¾…æ¸¬è©¦é–‹å§‹...</pre>
        </div>
    </div>

    <!-- è¼‰å…¥ Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- è¼‰å…¥æ–°çš„åŒæ­¥æœå‹™ v2 -->
    <script src="supabase-sync-v2.js"></script>

    <script>
        let testResults = document.getElementById('results');
        let debugLog = document.getElementById('debug-log');
        let progress = document.getElementById('progress');
        let liveStatus = document.getElementById('live-status');
        let currentProgress = 0;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }

        function updateProgress(percent) {
            currentProgress = Math.min(100, Math.max(0, percent));
            progress.style.width = currentProgress + '%';
        }

        function updateStatus(network, supabase, sync) {
            const statusMap = {
                true: 'online',
                false: 'offline',
                'loading': 'loading'
            };
            
            if (network !== undefined) {
                const badge = liveStatus.children[0];
                badge.className = `status-badge status-${statusMap[network]}`;
                badge.textContent = network === true ? 'ç·šä¸Š' : network === false ? 'é›¢ç·š' : 'æª¢æŸ¥ä¸­';
            }
            
            if (supabase !== undefined) {
                const badge = liveStatus.children[1];
                badge.className = `status-badge status-${statusMap[supabase]}`;
                badge.textContent = supabase === true ? 'é€£æ¥æˆåŠŸ' : supabase === false ? 'é€£æ¥å¤±æ•—' : 'æª¢æŸ¥ä¸­';
            }
            
            if (sync !== undefined) {
                const badge = liveStatus.children[2];
                badge.className = `status-badge status-${statusMap[sync]}`;
                badge.textContent = sync === true ? 'æœå‹™æ­£å¸¸' : sync === false ? 'æœå‹™ç•°å¸¸' : 'æª¢æŸ¥ä¸­';
            }
        }

        function addTestResult(title, status, content, details = '') {
            const icons = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            };
            
            const card = document.createElement('div');
            card.className = `test-card ${status}`;
            card.innerHTML = `
                <h3><span class="icon">${icons[status]}</span> ${title}</h3>
                <div>${content}</div>
                ${details ? `<details style="margin-top: 10px;"><summary style="cursor: pointer;">è©³ç´°è³‡è¨Š</summary><pre style="margin-top: 10px;">${details}</pre></details>` : ''}
            `;
            
            testResults.appendChild(card);
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function runFullTest() {
            testResults.innerHTML = '';
            updateProgress(0);
            log('ğŸš€ é–‹å§‹æœ€çµ‚å®Œæ•´æ¸¬è©¦...');

            // æ¸¬è©¦ 1: åŸºç¤ç’°å¢ƒ (20%)
            log('æ­¥é©Ÿ 1/5: æª¢æŸ¥åŸºç¤ç’°å¢ƒ');
            const networkOnline = navigator.onLine;
            updateStatus(networkOnline, 'loading', 'loading');
            
            addTestResult(
                'åŸºç¤ç’°å¢ƒæª¢æŸ¥',
                'success',
                `ç€è¦½å™¨: ${navigator.userAgent.split(' ').slice(-2).join(' ')}<br>
                 åŸŸå: ${window.location.hostname}<br>
                 ç¶²è·¯: ${networkOnline ? 'âœ… ç·šä¸Š' : 'âŒ é›¢ç·š'}<br>
                 å­˜å„²: ${typeof(Storage) !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}`
            );
            updateProgress(20);

            // æ¸¬è©¦ 2: SDK æª¢æŸ¥ (40%)
            log('æ­¥é©Ÿ 2/5: æª¢æŸ¥ Supabase SDK');
            await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾… SDK è¼‰å…¥
            
            if (typeof window.supabase !== 'undefined') {
                addTestResult('Supabase SDK', 'success', 'SDK è¼‰å…¥æˆåŠŸ');
                log('âœ… Supabase SDK æª¢æŸ¥é€šé');
            } else {
                addTestResult('Supabase SDK', 'error', 'SDK è¼‰å…¥å¤±æ•—');
                log('âŒ Supabase SDK æª¢æŸ¥å¤±æ•—');
                updateStatus(networkOnline, false, false);
                return;
            }
            updateProgress(40);

            // æ¸¬è©¦ 3: é€£æ¥æ¸¬è©¦ (60%)
            log('æ­¥é©Ÿ 3/5: æ¸¬è©¦ Supabase é€£æ¥');
            try {
                const client = window.supabase.createClient(
                    'https://nfncwofzfjdvyhdfjbzw.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mbmN3b2Z6ZmpkdnloZGZqYnp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MjM0MDcsImV4cCI6MjA3MzA5OTQwN30.ZyLtV91pG618utDhJhGJbZpbFPZ_IEx2mBPc7GVfkH4'
                );

                const { data, error } = await client
                    .from('temple_data')
                    .select('count')
                    .limit(1);

                if (error) {
                    updateStatus(networkOnline, false, 'loading');
                    addTestResult(
                        'Supabase é€£æ¥æ¸¬è©¦', 
                        'error', 
                        `é€£æ¥å¤±æ•—: ${error.message}`,
                        `éŒ¯èª¤ä»£ç¢¼: ${error.code}\néŒ¯èª¤è©³æƒ…: ${error.details}\næç¤º: ${error.hint}`
                    );
                    log(`âŒ Supabase é€£æ¥å¤±æ•—: ${error.message}`);
                    
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        addTestResult(
                            'å•é¡Œè¨ºæ–·',
                            'warning',
                            'è³‡æ–™è¡¨ temple_data ä¸å­˜åœ¨ï¼',
                            'è«‹åœ¨ Supabase æ§åˆ¶å°çš„ SQL Editor ä¸­åŸ·è¡Œå»ºè¡¨è…³æœ¬'
                        );
                    }
                } else {
                    updateStatus(networkOnline, true, 'loading');
                    addTestResult('Supabase é€£æ¥æ¸¬è©¦', 'success', 'é€£æ¥æˆåŠŸï¼');
                    log('âœ… Supabase é€£æ¥æ¸¬è©¦é€šé');
                }
            } catch (error) {
                updateStatus(networkOnline, false, 'loading');
                addTestResult('Supabase é€£æ¥æ¸¬è©¦', 'error', `æ¸¬è©¦å¤±æ•—: ${error.message}`);
                log(`âŒ Supabase é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
            updateProgress(60);

            // æ¸¬è©¦ 4: åŒæ­¥æœå‹™æª¢æŸ¥ (80%)
            log('æ­¥é©Ÿ 4/5: æª¢æŸ¥åŒæ­¥æœå‹™ v2');
            await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…æœå‹™åˆå§‹åŒ–
            
            if (window.supabaseSyncV2 && window.supabaseSync) {
                const status = window.supabaseSync.getSyncStatus();
                updateStatus(networkOnline, undefined, true);
                
                addTestResult(
                    'åŒæ­¥æœå‹™ v2.0', 
                    'success', 
                    'æ–°ç‰ˆåŒæ­¥æœå‹™å·²è¼‰å…¥ï¼',
                    `è¨­å‚™ ID: ${status.deviceId}\nç¶²è·¯ç‹€æ…‹: ${status.isOnline ? 'ç·šä¸Š' : 'é›¢ç·š'}\næä¾›å•†: ${status.provider}\næœ€å¾ŒåŒæ­¥: ${status.lastSyncTime}`
                );
                log('âœ… åŒæ­¥æœå‹™ v2.0 æª¢æŸ¥é€šé');
                
                // å•Ÿç”¨å¿«é€ŸåŒæ­¥æŒ‰éˆ•
                document.getElementById('syncBtn').disabled = false;
            } else {
                updateStatus(networkOnline, undefined, false);
                addTestResult('åŒæ­¥æœå‹™ v2.0', 'error', 'æ–°ç‰ˆåŒæ­¥æœå‹™è¼‰å…¥å¤±æ•—');
                log('âŒ åŒæ­¥æœå‹™ v2.0 æª¢æŸ¥å¤±æ•—');
            }
            updateProgress(80);

            // æ¸¬è©¦ 5: å®Œæ•´æ€§æª¢æŸ¥ (100%)
            log('æ­¥é©Ÿ 5/5: æœ€çµ‚æª¢æŸ¥');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const allSystemsGo = networkOnline && 
                                 (typeof window.supabase !== 'undefined') && 
                                 window.supabaseSyncV2;
            
            if (allSystemsGo) {
                addTestResult(
                    'ç³»çµ±ç‹€æ…‹',
                    'success',
                    'ğŸ‰ æ‰€æœ‰ç³»çµ±æ­£å¸¸ï¼é›²ç«¯åŒæ­¥å·²æº–å‚™å°±ç·’ï¼',
                    'ä½ ç¾åœ¨å¯ä»¥:\n1. é»æ“Šã€Œå¿«é€ŸåŒæ­¥æ¸¬è©¦ã€é€²è¡Œå¯¦éš›æ¸¬è©¦\n2. åœ¨æ‡‰ç”¨ä¸­ä½¿ç”¨ã€Œé›²ç«¯åŒæ­¥ã€åŠŸèƒ½\n3. åœ¨å…¶ä»–è¨­å‚™ä¸Šä½¿ç”¨ã€Œç«‹å³åŒæ­¥ã€åŠŸèƒ½'
                );
                log('ğŸ‰ æœ€çµ‚æ¸¬è©¦å®Œæˆ - ç³»çµ±å®Œå…¨æ­£å¸¸ï¼');
            } else {
                addTestResult('ç³»çµ±ç‹€æ…‹', 'warning', 'éƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ï¼Œä½†å¯ä»¥å˜—è©¦ä½¿ç”¨');
                log('âš ï¸ æœ€çµ‚æ¸¬è©¦å®Œæˆ - ç™¼ç¾éƒ¨åˆ†å•é¡Œ');
            }
            
            updateProgress(100);
            log('=== æ¸¬è©¦å®Œæˆ ===');
        }

        async function testQuickSync() {
            log('ğŸš€ é–‹å§‹å¿«é€ŸåŒæ­¥æ¸¬è©¦...');
            
            if (!window.supabaseSync) {
                addTestResult('å¿«é€ŸåŒæ­¥', 'error', 'åŒæ­¥æœå‹™ä¸å¯ç”¨');
                return;
            }

            try {
                // ç”Ÿæˆæ¸¬è©¦æ•¸æ“š
                const testRecord = {
                    id: 'quick_test_' + Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    type: 'æ”¶å…¥',
                    category: 'å¿«é€Ÿæ¸¬è©¦',
                    amount: 999,
                    description: 'å¿«é€ŸåŒæ­¥æ¸¬è©¦æ•¸æ“š',
                    timestamp: Date.now()
                };

                // æ·»åŠ åˆ°æœ¬åœ°å­˜å„²
                const records = JSON.parse(localStorage.getItem('temple-records') || '[]');
                records.push(testRecord);
                localStorage.setItem('temple-records', JSON.stringify(records));
                localStorage.setItem('temple-last-modified', Date.now().toString());

                log('å·²ç”Ÿæˆæ¸¬è©¦æ•¸æ“šï¼Œé–‹å§‹ä¸Šå‚³...');

                // åŸ·è¡ŒåŒæ­¥
                const result = await window.supabaseSync.syncToCloud();

                if (result.success) {
                    addTestResult(
                        'å¿«é€ŸåŒæ­¥æ¸¬è©¦',
                        'success',
                        'ğŸ‰ åŒæ­¥æ¸¬è©¦æˆåŠŸï¼é›²ç«¯åŒæ­¥åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼',
                        `æä¾›å•†: ${result.provider}\nåŒæ­¥æ™‚é–“: ${result.syncTime}\nè¨­å‚™ ID: ${result.deviceId}\nè¨Šæ¯: ${result.message}`
                    );
                    log('ğŸ‰ å¿«é€ŸåŒæ­¥æ¸¬è©¦æˆåŠŸï¼');
                    
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    const cleanRecords = records.filter(r => r.id !== testRecord.id);
                    localStorage.setItem('temple-records', JSON.stringify(cleanRecords));
                    log('å·²æ¸…ç†æ¸¬è©¦æ•¸æ“š');
                } else {
                    addTestResult('å¿«é€ŸåŒæ­¥æ¸¬è©¦', 'error', `åŒæ­¥å¤±æ•—: ${result.message}`);
                    log(`âŒ å¿«é€ŸåŒæ­¥æ¸¬è©¦å¤±æ•—: ${result.message}`);
                }
            } catch (error) {
                addTestResult('å¿«é€ŸåŒæ­¥æ¸¬è©¦', 'error', `æ¸¬è©¦å¤±æ•—: ${error.message}`);
                log(`âŒ å¿«é€ŸåŒæ­¥æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('æœ€çµ‚æ¸¬è©¦å·¥å…·å·²è¼‰å…¥ v2.0');
            updateStatus('loading', 'loading', 'loading');
            
            // 3ç§’å¾Œè‡ªå‹•é–‹å§‹æ¸¬è©¦
            setTimeout(() => {
                log('3ç§’å¾Œè‡ªå‹•é–‹å§‹æ¸¬è©¦...');
                setTimeout(runFullTest, 3000);
            }, 1000);
        });

        // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
        window.addEventListener('online', () => {
            log('ç¶²è·¯ç‹€æ…‹ï¼šå·²é€£æ¥');
            updateStatus(true, undefined, undefined);
        });
        
        window.addEventListener('offline', () => {
            log('ç¶²è·¯ç‹€æ…‹ï¼šå·²æ–·ç·š');
            updateStatus(false, undefined, undefined);
        });
    </script>
</body>
</html>