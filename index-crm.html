<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£æ¸…å®®æ™ºèƒ½è¨˜å¸³ç³»çµ± - CRMç‰ˆ</title>
    
    <!-- PWAæ”¯æ´ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- ECharts -->
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <!-- Day.js -->
    <script src="https://unpkg.com/dayjs@1.11.9/dayjs.min.js"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    
    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #f56c6c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .bottom-nav {
            background: white;
            border-top: 1px solid #ebeef5;
            padding: 8px 0;
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            transition: color 0.3s ease;
            min-width: 60px;
        }
        
        .nav-item.active {
            color: #409eff;
        }
        
        .nav-item:hover {
            color: #409eff;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        .app-main {
            flex: 1;
            padding: 20px 20px 80px 20px;
            overflow-y: auto;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-card.income {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .stat-card.expense {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }
        
        .stat-card.balance {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #303133;
        }
        
        .stat-card.analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stat-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .trend-up {
            color: #67c23a;
        }
        
        .trend-down {
            color: #f56c6c;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            touch-action: manipulation;
        }
        
        .action-card:hover, .action-card:active {
            border-color: #409eff;
            transform: translateY(-2px);
        }
        
        .action-icon {
            font-size: 32px;
            margin-bottom: 12px;
            color: #409eff;
        }
        
        .action-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
        }
        
        .records-section, .reminders-section, .analysis-section, .budget-section, .crm-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #303133;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .analysis-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid #409eff;
        }
        
        .analysis-title {
            font-weight: 600;
            color: #303133;
            margin-bottom: 8px;
        }
        
        .analysis-value {
            font-size: 20px;
            font-weight: bold;
            color: #409eff;
            margin-bottom: 4px;
        }
        
        .analysis-desc {
            font-size: 12px;
            color: #909399;
        }
        
        .record-item, .reminder-item, .budget-item, .donor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #ebeef5;
        }
        
        .record-item:last-child, .reminder-item:last-child, .budget-item:last-child, .donor-item:last-child {
            border-bottom: none;
        }
        
        .record-info, .reminder-info, .budget-info, .donor-info {
            flex: 1;
        }
        
        .record-category, .reminder-title, .budget-category, .donor-name {
            font-weight: 500;
            color: #303133;
        }
        
        .record-description, .reminder-description, .donor-details {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
        }
        
        .record-amount, .donor-amount {
            font-weight: 600;
            font-family: monospace;
        }
        
        .record-amount.income, .donor-amount {
            color: #67c23a;
        }
        
        .record-amount.expense {
            color: #f56c6c;
        }
        
        .reminder-date {
            font-size: 12px;
            color: #f56c6c;
            font-weight: 500;
        }
        
        .reminder-item.urgent {
            background: #fef0f0;
            border-left: 4px solid #f56c6c;
            padding-left: 16px;
        }
        
        .reminder-item.warning {
            background: #fdf6ec;
            border-left: 4px solid #e6a23c;
            padding-left: 16px;
        }
        
        .budget-progress {
            width: 100%;
            height: 8px;
            background-color: #ebeef5;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #67c23a;
            transition: width 0.5s ease;
        }
        
        .progress-bar.warning {
            background-color: #e6a23c;
        }
        
        .progress-bar.danger {
            background-color: #f56c6c;
        }
        
        .budget-details {
            font-size: 12px;
            color: #909399;
            margin-top: 4px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #909399;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #303133;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #409eff;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: #409eff;
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            background: #337ecc;
        }
        
        .btn-secondary {
            background: #909399;
            color: white;
            margin-right: 12px;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background: #73767a;
        }
        
        .btn-danger {
            background: #f56c6c;
            color: white;
        }
        
        .btn-danger:hover, .btn-danger:active {
            background: #f23030;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #909399;
        }
        
        .notification-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #f56c6c;
            z-index: 3000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-title {
            font-weight: 600;
            color: #303133;
            margin-bottom: 8px;
        }
        
        .notification-message {
            color: #606266;
            font-size: 14px;
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        .reminder-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .time-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: #409eff;
            color: white;
            border-color: #409eff;
        }
        
        .suggestion-card {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .suggestion-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
        }
        
        .suggestion-desc {
            color: #3730a3;
            font-size: 14px;
        }
        
        /* æ‰‹æ©Ÿå„ªåŒ– */
        @media (max-width: 768px) {
            .app-main {
                padding: 15px 15px 80px 15px;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .form-input, .form-select, .form-textarea {
                font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
            }
            
            .time-filter {
                justify-content: center;
            }
        }
        
        /* PWAæ¨£å¼ */
        @media (display-mode: standalone) {
            .app-header {
                padding-top: env(safe-area-inset-top);
            }
            
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- é ‚éƒ¨æ¨™é¡Œ -->
            <div class="app-header">
                <div class="app-title">å»£æ¸…å®®æ™ºèƒ½è¨˜å¸³ç³»çµ±</div>
                <div class="header-actions">
                    <button class="btn btn-primary" @click="showAddModal = true" style="padding: 8px 12px; font-size: 14px;">
                        å¿«é€Ÿè¨˜å¸³
                    </button>
                    <div style="position: relative;">
                        <button class="btn btn-secondary" @click="showNotifications" style="padding: 8px 12px; font-size: 14px;">
                            ğŸ””
                        </button>
                        <div v-if="urgentReminders.length > 0" class="notification-badge">
                            {{ urgentReminders.length }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»è¦å…§å®¹ -->
            <div class="app-main">
                <!-- å„€è¡¨æ¿é é¢ -->
                <div class="page-content active" id="dashboard">
                    <!-- ç·Šæ€¥æé†’ -->
                    <div v-if="urgentReminders.length > 0" class="reminders-section">
                        <div class="section-title">
                            ğŸš¨ ç·Šæ€¥æé†’
                        </div>
                        <div v-for="reminder in urgentReminders" :key="reminder.id" :class="['reminder-item', reminder.urgency]">
                            <div class="reminder-info">
                                <div class="reminder-title">{{ reminder.title }}</div>
                                <div class="reminder-description">{{ reminder.description }}</div>
                                <div class="reminder-date">{{ formatReminderDate(reminder.dueDate) }}</div>
                                <div class="reminder-actions">
                                    <button class="btn btn-primary btn-small" @click="markReminderDone(reminder.id)">
                                        å®Œæˆ
                                    </button>
                                    <button class="btn btn-secondary btn-small" @click="snoozeReminder(reminder.id)">
                                        ç¨å¾Œæé†’
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çµ±è¨ˆå¡ç‰‡ -->
                    <div class="dashboard-cards">
                        <div class="stat-card income">
                            <div class="stat-value">{{ formatCurrency(totalIncome) }}</div>
                            <div class="stat-label">ç¸½æ”¶å…¥</div>
                            <div class="stat-trend">
                                <span :class="incomeTrend.direction === 'up' ? 'trend-up' : 'trend-down'">
                                    {{ incomeTrend.direction === 'up' ? 'â†—' : 'â†˜' }} {{ incomeTrend.percentage }}%
                                </span>
                            </div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-value">{{ formatCurrency(totalExpense) }}</div>
                            <div class="stat-label">ç¸½æ”¯å‡º</div>
                            <div class="stat-trend">
                                <span :class="expenseTrend.direction === 'up' ? 'trend-down' : 'trend-up'">
                                    {{ expenseTrend.direction === 'up' ? 'â†—' : 'â†˜' }} {{ expenseTrend.percentage }}%
                                </span>
                            </div>
                        </div>
                        <div class="stat-card balance">
                            <div class="stat-value">{{ formatCurrency(totalBalance) }}</div>
                            <div class="stat-label">çµé¤˜</div>
                            <div class="stat-trend">
                                <span :class="balanceTrend.direction === 'up' ? 'trend-up' : 'trend-down'">
                                    {{ balanceTrend.direction === 'up' ? 'â†—' : 'â†˜' }} {{ balanceTrend.percentage }}%
                                </span>
                            </div>
                        </div>
                        <div class="stat-card analysis">
                            <div class="stat-value">{{ healthScore }}åˆ†</div>
                            <div class="stat-label">è²¡å‹™å¥åº·åº¦</div>
                            <div class="stat-trend">
                                <span class="trend-up">{{ healthStatus }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿæ“ä½œ -->
                    <div class="quick-actions">
                        <div class="action-card" @click="openAddModal('income')">
                            <div class="action-icon">ğŸ’°</div>
                            <div class="action-title">æ–°å¢æ”¶å…¥</div>
                        </div>
                        <div class="action-card" @click="openAddModal('expense')">
                            <div class="action-icon">ğŸ’¸</div>
                            <div class="action-title">æ–°å¢æ”¯å‡º</div>
                        </div>
                    </div>
                    
                    <!-- åœ–è¡¨åˆ†æ -->
                    <div class="analysis-section">
                        <div class="section-title">
                            ğŸ“Š æ”¶æ”¯è¶¨å‹¢åˆ†æ
                            <button class="btn btn-secondary btn-small" @click="switchPage('analysis')">
                                æŸ¥çœ‹è©³ç´°
                            </button>
                        </div>
                        <div class="chart-container" id="dashboardChart"></div>
                    </div>
                    
                    <!-- æ™ºèƒ½åˆ†æ -->
                    <div class="analysis-section">
                        <div class="section-title">ğŸ¤– æ™ºèƒ½è²¡å‹™åˆ†æ</div>
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <div class="analysis-title">æ”¶æ”¯æ¯”ä¾‹</div>
                                <div class="analysis-value">{{ incomeExpenseRatio }}%</div>
                                <div class="analysis-desc">{{ incomeExpenseAnalysis }}</div>
                            </div>
                            <div class="analysis-card">
                                <div class="analysis-title">å¹³å‡æ—¥æ”¶å…¥</div>
                                <div class="analysis-value">{{ formatCurrency(avgDailyIncome) }}</div>
                                <div class="analysis-desc">{{ avgIncomeAnalysis }}</div>
                            </div>
                            <div class="analysis-card">
                                <div class="analysis-title">æœ€å¤§æ”¯å‡ºé¡åˆ¥</div>
                                <div class="analysis-value">{{ topExpenseCategory.name }}</div>
                                <div class="analysis-desc">ä½”ç¸½æ”¯å‡º {{ topExpenseCategory.percentage }}%</div>
                            </div>
                            <div class="analysis-card">
                                <div class="analysis-title">é æ¸¬çµé¤˜</div>
                                <div class="analysis-value">{{ formatCurrency(predictedBalance) }}</div>
                                <div class="analysis-desc">{{ balancePrediction }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æœ€è¿‘è¨˜éŒ„ -->
                    <div class="records-section">
                        <div class="section-title">æœ€è¿‘è¨˜éŒ„</div>
                        <div v-if="recentRecords.length === 0" class="empty-state">
                            <div>æš«ç„¡è¨˜éŒ„</div>
                            <div style="margin-top: 8px; font-size: 12px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹è¨˜å¸³</div>
                        </div>
                        <div v-else>
                            <div v-for="record in recentRecords" :key="record.id" class="record-item">
                                <div class="record-info">
                                    <div class="record-category">{{ record.category }}</div>
                                    <div class="record-description">
                                        {{ record.description }} - {{ formatDate(record.date) }}
                                    </div>
                                </div>
                                <div :class="['record-amount', record.type]">
                                    {{ record.type === 'income' ? '+' : '-' }}{{ formatCurrency(record.amount) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- åˆ†æé é¢ -->
                <div class="page-content" id="analysis">
                    <div class="analysis-section">
                        <div class="section-title">
                            ğŸ“ˆ æ·±åº¦è²¡å‹™åˆ†æ
                        </div>
                        
                        <!-- æ™‚é–“ç¯©é¸ -->
                        <div class="time-filter">
                            <button 
                                v-for="filter in timeFilters" 
                                :key="filter.key"
                                :class="['filter-btn', { active: selectedTimeFilter === filter.key }]"
                                @click="selectedTimeFilter = filter.key; updateCharts()"
                            >
                                {{ filter.label }}
                            </button>
                        </div>
                        
                        <!-- æ”¶æ”¯è¶¨å‹¢åœ– -->
                        <div class="chart-container" id="trendChart"></div>
                        
                        <!-- é¡åˆ¥åˆ†æåœ– -->
                        <div class="chart-container" id="categoryChart"></div>
                        
                        <!-- æœˆåº¦å°æ¯”åœ– -->
                        <div class="chart-container" id="monthlyChart"></div>
                        
                        <!-- è²¡å‹™å»ºè­° -->
                        <div class="section-title" style="margin-top: 30px;">ğŸ’¡ æ™ºèƒ½è²¡å‹™å»ºè­°</div>
                        <div v-for="suggestion in financialSuggestions" :key="suggestion.id" class="suggestion-card">
                            <div class="suggestion-title">{{ suggestion.title }}</div>
                            <div class="suggestion-desc">{{ suggestion.description }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- é ç®—é é¢ -->
                <div class="page-content" id="budget">
                    <div class="budget-section">
                        <div class="section-title">
                            ğŸ’° é ç®—ç®¡ç†
                            <button class="btn btn-secondary btn-small" @click="copyLastMonthBudget">è¤‡è£½ä¸Šæœˆé ç®—</button>
                        </div>
                        
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <div class="analysis-title">ç¸½é ç®—</div>
                                <div class="analysis-value">{{ formatCurrency(totalBudget) }}</div>
                                <div class="analysis-desc">æœ¬æœˆæ”¯å‡ºç¸½é ç®—</div>
                            </div>
                            <div class="analysis-card">
                                <div class="analysis-title">ç¸½æ”¯å‡º</div>
                                <div class="analysis-value">{{ formatCurrency(totalExpenseForMonth) }}</div>
                                <div class="analysis-desc">æœ¬æœˆå·²æ”¯å‡º</div>
                            </div>
                            <div class="analysis-card">
                                <div class="analysis-title">å‰©é¤˜é ç®—</div>
                                <div class="analysis-value">{{ formatCurrency(remainingBudget) }}</div>
                                <div class="analysis-desc">{{ budgetStatus }}</div>
                            </div>
                        </div>
                        
                        <div v-for="item in budgetSummary" :key="item.category" class="budget-item">
                            <div class="budget-info">
                                <div class="budget-category">{{ item.category }}</div>
                                <div class="budget-progress">
                                    <div 
                                        class="progress-bar" 
                                        :class="{ warning: item.percentage > 75 && item.percentage <= 100, danger: item.percentage > 100 }"
                                        :style="{ width: Math.min(item.percentage, 100) + '%' }"
                                    ></div>
                                </div>
                                <div class="budget-details">
                                    å·²ç”¨: {{ formatCurrency(item.spent) }} / é ç®—: {{ formatCurrency(item.budget) }}
                                </div>
                            </div>
                            <button class="btn btn-primary btn-small" @click="openBudgetModal(item.category, item.budget)">
                                è¨­å®š
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ä¿¡çœ¾ç®¡ç†é é¢ -->
                <div class="page-content" id="donors">
                    <div class="crm-section">
                        <div class="section-title">
                            ğŸ‘¥ ä¿¡çœ¾ç®¡ç†
                        </div>
                        <input type="text" class="form-input" placeholder="æœå°‹ä¿¡çœ¾..." v-model="donorSearchQuery">
                        
                        <div v-if="filteredDonors.length === 0" class="empty-state">
                            <div>æš«ç„¡ä¿¡çœ¾è³‡æ–™</div>
                        </div>
                        <div v-else>
                            <div v-for="donor in filteredDonors" :key="donor.id" class="donor-item" @click="showDonorDetails(donor)">
                                <div class="donor-info">
                                    <div class="donor-name">{{ donor.name }}</div>
                                    <div class="donor-details">
                                        ç¸½ææ¬¾: {{ formatCurrency(donor.totalDonation) }} | æ¬¡æ•¸: {{ donor.donationCount }} | æœ€è¿‘ææ¬¾: {{ formatDate(donor.lastDonationDate) }}
                                    </div>
                                </div>
                                <div class="donor-amount">
                                    {{ formatCurrency(donor.totalDonation) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æé†’é é¢ -->
                <div class="page-content" id="reminders">
                    <div class="reminders-section">
                        <div class="section-title">
                            æé†’ç®¡ç†
                            <button class="btn btn-primary btn-small" @click="showReminderModal = true">
                                æ–°å¢æé†’
                            </button>
                        </div>
                        <div v-if="allReminders.length === 0" class="empty-state">
                            <div>æš«ç„¡æé†’</div>
                            <div style="margin-top: 8px; font-size: 12px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢æé†’</div>
                        </div>
                        <div v-else>
                            <div v-for="reminder in allReminders" :key="reminder.id" :class="['reminder-item', reminder.urgency]">
                                <div class="reminder-info">
                                    <div class="reminder-title">{{ reminder.title }}</div>
                                    <div class="reminder-description">{{ reminder.description }}</div>
                                    <div class="reminder-date">{{ formatReminderDate(reminder.dueDate) }}</div>
                                    <div class="reminder-actions">
                                        <button class="btn btn-primary btn-small" @click="markReminderDone(reminder.id)">
                                            å®Œæˆ
                                        </button>
                                        <button class="btn btn-secondary btn-small" @click="editReminder(reminder)">
                                            ç·¨è¼¯
                                        </button>
                                        <button class="btn btn-danger btn-small" @click="deleteReminder(reminder.id)">
                                            åˆªé™¤
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¨­å®šé é¢ -->
                <div class="page-content" id="settings">
                    <div class="records-section">
                        <div class="section-title">ç³»çµ±è¨­å®š</div>
                        <div class="quick-actions" style="grid-template-columns: 1fr;">
                            <div class="action-card" @click="exportData">
                                <div class="action-icon">ğŸ“Š</div>
                                <div class="action-title">åŒ¯å‡ºè³‡æ–™</div>
                            </div>
                            <div class="action-card" @click="generateTestData">
                                <div class="action-icon">ğŸ²</div>
                                <div class="action-title">ç”Ÿæˆæ¸¬è©¦è³‡æ–™</div>
                            </div>
                            <div class="action-card" @click="clearAllData">
                                <div class="action-icon">ğŸ—‘ï¸</div>
                                <div class="action-title">æ¸…é™¤æ‰€æœ‰è³‡æ–™</div>
                            </div>
                            <div class="action-card" @click="installApp">
                                <div class="action-icon">ğŸ“±</div>
                                <div class="action-title">å®‰è£åˆ°æ‰‹æ©Ÿ</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 10px;">åŠŸèƒ½ç‰¹è‰²</h4>
                            <ul style="padding-left: 20px; color: #606266; font-size: 14px; line-height: 1.6;">
                                <li>ğŸ‘¥ ä¿¡çœ¾ç®¡ç† (CRM)</li>
                                <li>ğŸ’° é ç®—ç®¡ç†ï¼Œæœ‰æ•ˆæ§åˆ¶é–‹æ”¯</li>
                                <li>ğŸ“Š æ™ºèƒ½è²¡å‹™åˆ†æï¼ŒAIè©•åˆ†ç³»çµ±</li>
                                <li>ğŸ“ˆ è¶¨å‹¢é æ¸¬ï¼Œå¹«åŠ©è²¡å‹™è¦åŠƒ</li>
                                <li>ğŸ”” æ™ºèƒ½æé†’ï¼Œé€±æœ«è‡ªå‹•èª¿æ•´</li>
                                <li>ğŸ’¡ å€‹æ€§åŒ–è²¡å‹™å»ºè­°</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å°èˆª -->
            <div class="bottom-nav">
                <div class="nav-item active" @click="switchPage('dashboard')">
                    <div class="nav-icon">ğŸ </div>
                    <div class="nav-label">é¦–é </div>
                </div>
                <div class="nav-item" @click="switchPage('analysis')">
                    <div class="nav-icon">ğŸ“Š</div>
                    <div class="nav-label">åˆ†æ</div>
                </div>
                <div class="nav-item" @click="switchPage('budget')">
                    <div class="nav-icon">ğŸ’°</div>
                    <div class="nav-label">é ç®—</div>
                </div>
                <div class="nav-item" @click="switchPage('donors')">
                    <div class="nav-icon">ğŸ‘¥</div>
                    <div class="nav-label">ä¿¡çœ¾</div>
                </div>
                <div class="nav-item" @click="switchPage('settings')">
                    <div class="nav-icon">âš™ï¸</div>
                    <div class="nav-label">è¨­å®š</div>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢è¨˜éŒ„å°è©±æ¡† -->
        <div v-if="showAddModal" class="modal" @click.self="closeAddModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">{{ modalTitle }}</div>
                    <button class="close-btn" @click="closeAddModal">&times;</button>
                </div>
                
                <form @submit.prevent="saveRecord">
                    <div class="form-group">
                        <label class="form-label">é¡å‹</label>
                        <select v-model="form.type" class="form-select" @change="updateCategories">
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é¡åˆ¥</label>
                        <select v-model="form.category" class="form-select" required>
                            <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                            <option v-for="category in currentCategories" :key="category" :value="category">
                                {{ category }}
                            </option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é‡‘é¡</label>
                        <input 
                            v-model.number="form.amount" 
                            type="number" 
                            class="form-input" 
                            placeholder="è«‹è¼¸å…¥é‡‘é¡"
                            min="1"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ—¥æœŸ</label>
                        <input 
                            v-model="form.date" 
                            type="date" 
                            class="form-input"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">èªªæ˜</label>
                        <input 
                            v-model="form.description" 
                            type="text" 
                            class="form-input" 
                            placeholder="è«‹è¼¸å…¥èªªæ˜"
                        >
                    </div>
                    
                    <div class="form-group" v-if="form.type === 'income'">
                        <label class="form-label">ææ¬¾äºº</label>
                        <input 
                            v-model="form.donor" 
                            type="text" 
                            class="form-input" 
                            placeholder="è«‹è¼¸å…¥ææ¬¾äººå§“åï¼ˆé¸å¡«ï¼‰"
                            list="donor-list"
                        >
                        <datalist id="donor-list">
                            <option v-for="donor in donors" :key="donor.id" :value="donor.name"></option>
                        </datalist>
                    </div>
                    
                    <div style="text-align: right; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" @click="closeAddModal">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            å„²å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- æ–°å¢æé†’å°è©±æ¡† -->
        <div v-if="showReminderModal" class="modal" @click.self="closeReminderModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">{{ reminderModalTitle }}</div>
                    <button class="close-btn" @click="closeReminderModal">&times;</button>
                </div>
                
                <form @submit.prevent="saveReminder">
                    <div class="form-group">
                        <label class="form-label">æé†’æ¨™é¡Œ</label>
                        <input 
                            v-model="reminderForm.title" 
                            type="text" 
                            class="form-input" 
                            placeholder="ä¾‹å¦‚ï¼šç¹³æˆ¿ç§Ÿ"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æé†’å…§å®¹</label>
                        <textarea 
                            v-model="reminderForm.description" 
                            class="form-textarea" 
                            placeholder="ä¾‹å¦‚ï¼šæ¯æœˆ25è™Ÿè¦ç¹³æˆ¿ç§Ÿçµ¦æˆ¿æ±"
                            required
                        ></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åˆ°æœŸæ—¥æœŸ</label>
                        <input 
                            v-model="reminderForm.dueDate" 
                            type="date" 
                            class="form-input"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é‡è¤‡é€±æœŸ</label>
                        <select v-model="reminderForm.repeat" class="form-select">
                            <option value="none">ä¸é‡è¤‡</option>
                            <option value="monthly">æ¯æœˆ</option>
                            <option value="yearly">æ¯å¹´</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æå‰æé†’å¤©æ•¸</label>
                        <select v-model="reminderForm.advanceDays" class="form-select">
                            <option value="1">1å¤©å‰</option>
                            <option value="2">2å¤©å‰</option>
                            <option value="3">3å¤©å‰</option>
                            <option value="7">7å¤©å‰</option>
                        </select>
                    </div>
                    
                    <div style="text-align: right; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" @click="closeReminderModal">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            å„²å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- è¨­å®šé ç®—å°è©±æ¡† -->
        <div v-if="showBudgetModal" class="modal" @click.self="showBudgetModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">è¨­å®šé ç®— - {{ budgetForm.category }}</div>
                    <button class="close-btn" @click="showBudgetModal = false">&times;</button>
                </div>
                
                <form @submit.prevent="saveBudget">
                    <div class="form-group">
                        <label class="form-label">é ç®—é‡‘é¡</label>
                        <input 
                            v-model.number="budgetForm.amount" 
                            type="number" 
                            class="form-input" 
                            placeholder="è«‹è¼¸å…¥é ç®—é‡‘é¡"
                            min="0"
                            required
                        >
                    </div>
                    
                    <div style="text-align: right; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" @click="showBudgetModal = false">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            å„²å­˜é ç®—
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- ä¿¡çœ¾è©³æƒ…å°è©±æ¡† -->
        <div v-if="selectedDonor" class="modal" @click.self="selectedDonor = null">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ä¿¡çœ¾è©³æƒ… - {{ selectedDonor.name }}</div>
                    <button class="close-btn" @click="selectedDonor = null">&times;</button>
                </div>
                
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <div class="analysis-title">ç¸½ææ¬¾é‡‘é¡</div>
                        <div class="analysis-value">{{ formatCurrency(selectedDonor.totalDonation) }}</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-title">ææ¬¾æ¬¡æ•¸</div>
                        <div class="analysis-value">{{ selectedDonor.donationCount }}</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-title">æœ€è¿‘ææ¬¾æ—¥</div>
                        <div class="analysis-value">{{ formatDate(selectedDonor.lastDonationDate) }}</div>
                    </div>
                </div>
                
                <div class="section-title" style="margin-top: 20px;">ææ¬¾è¨˜éŒ„</div>
                <div v-if="getDonorRecords(selectedDonor.name).length === 0" class="empty-state">
                    <div>æš«ç„¡ææ¬¾è¨˜éŒ„</div>
                </div>
                <div v-else>
                    <div v-for="record in getDonorRecords(selectedDonor.name)" :key="record.id" class="record-item">
                        <div class="record-info">
                            <div class="record-category">{{ record.category }}</div>
                            <div class="record-description">
                                {{ record.description }} - {{ formatDate(record.date) }}
                            </div>
                        </div>
                        <div class="record-amount income">
                            +{{ formatCurrency(record.amount) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é€šï¿½ï¿½ï¿½å½ˆçª— -->
        <div v-if="showNotificationPopup" class="notification-popup">
            <div class="notification-title">{{ currentNotification.title }}</div>
            <div class="notification-message">{{ currentNotification.message }}</div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        
        // IndexedDB è³‡æ–™åº«è¨­å®š
        const db = new Dexie('TempleAccountingDB_CRM');
        db.version(1).stores({
            records: '++id, type, category, amount, date, description, donor, createdAt',
            reminders: '++id, title, description, dueDate, repeat, advanceDays, completed, createdAt',
            budgets: '&month, data',
            donors: '&name, totalDonation, donationCount, lastDonationDate'
        });
        
        createApp({
            setup() {
                // éŸ¿æ‡‰å¼è³‡æ–™
                const showAddModal = ref(false);
                const showReminderModal = ref(false);
                const showBudgetModal = ref(false);
                const showNotificationPopup = ref(false);
                const currentPage = ref('dashboard');
                const records = ref([]);
                const reminders = ref([]);
                const budgets = ref({});
                const donors = ref([]);
                const editingReminder = ref(null);
                const currentNotification = ref({});
                const selectedTimeFilter = ref('3months');
                const donorSearchQuery = ref('');
                const selectedDonor = ref(null);
                
                const form = ref({
                    type: 'income',
                    category: '',
                    amount: null,
                    date: new Date().toISOString().split('T')[0],
                    description: '',
                    donor: ''
                });
                
                const reminderForm = ref({
                    title: '',
                    description: '',
                    dueDate: '',
                    repeat: 'none',
                    advanceDays: 2
                });
                
                const budgetForm = ref({
                    category: '',
                    amount: null
                });
                
                // æ™‚é–“ç¯©é¸é¸é …
                const timeFilters = [
                    { key: '1month', label: 'è¿‘1å€‹æœˆ' },
                    { key: '3months', label: 'è¿‘3å€‹æœˆ' },
                    { key: '6months', label: 'è¿‘6å€‹æœˆ' },
                    { key: '1year', label: 'è¿‘1å¹´' },
                    { key: 'all', label: 'å…¨éƒ¨' }
                ];
                
                // é¡åˆ¥å®šç¾©
                const incomeCategories = [
                    'é¦™æ²¹éŒ¢', 'é»å…‰æ˜ç‡ˆ', 'å±¬åç´…åŒ…', 'æœªå±¬åç´…åŒ…', 
                    'ç¥å£½', 'çœ‹é¢¨æ°´', 'åœè»Šè²»', 'æ„Ÿè¬ç¥å°Š', 'å…¶ä»–'
                ];
                
                const expenseCategories = [
                    'äººå“¡è–ªæ°´', 'æˆ¿ç§Ÿ', 'æ°´é›»è²»', 'é›œé …é–‹æ”¯', 
                    'åƒè¨ªé‡‘', 'ä¿®ç¹•è²»', 'ç®¡ç†è²»', 'å…¶ä»–'
                ];
                
                // è¨ˆç®—å±¬æ€§
                const currentCategories = computed(() => {
                    return form.value.type === 'income' ? incomeCategories : expenseCategories;
                });
                
                const modalTitle = computed(() => {
                    return form.value.type === 'income' ? 'æ–°å¢æ”¶å…¥' : 'æ–°å¢æ”¯å‡º';
                });
                
                const reminderModalTitle = computed(() => {
                    return editingReminder.value ? 'ç·¨è¼¯æé†’' : 'æ–°å¢æé†’';
                });
                
                // æ ¹æ“šæ™‚é–“ç¯©é¸ç²å–è¨˜éŒ„
                const filteredRecords = computed(() => {
                    if (selectedTimeFilter.value === 'all') {
                        return records.value;
                    }
                    
                    const now = new Date();
                    let startDate = new Date();
                    
                    switch (selectedTimeFilter.value) {
                        case '1month':
                            startDate.setMonth(now.getMonth() - 1);
                            break;
                        case '3months':
                            startDate.setMonth(now.getMonth() - 3);
                            break;
                        case '6months':
                            startDate.setMonth(now.getMonth() - 6);
                            break;
                        case '1year':
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    return records.value.filter(record => {
                        const recordDate = new Date(record.date);
                        return recordDate >= startDate;
                    });
                });
                
                const filteredDonors = computed(() => {
                    if (!donorSearchQuery.value) {
                        return donors.value.sort((a, b) => b.totalDonation - a.totalDonation);
                    }
                    return donors.value.filter(donor => 
                        donor.name.toLowerCase().includes(donorSearchQuery.value.toLowerCase())
                    ).sort((a, b) => b.totalDonation - a.totalDonation);
                });
                
                const totalIncome = computed(() => {
                    return filteredRecords.value
                        .filter(r => r.type === 'income')
                        .reduce((sum, r) => sum + r.amount, 0);
                });
                
                const totalExpense = computed(() => {
                    return filteredRecords.value
                        .filter(r => r.type === 'expense')
                        .reduce((sum, r) => sum + r.amount, 0);
                });
                
                const totalBalance = computed(() => {
                    return totalIncome.value - totalExpense.value;
                });
                
                const recentRecords = computed(() => {
                    return records.value
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .slice(0, 10);
                });
                
                const allReminders = computed(() => {
                    return reminders.value
                        .filter(r => !r.completed)
                        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                });
                
                const urgentReminders = computed(() => {
                    const today = new Date();
                    return allReminders.value.filter(reminder => {
                        const dueDate = new Date(reminder.dueDate);
                        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (diffDays <= reminder.advanceDays) {
                            const dayOfWeek = dueDate.getDay();
                            if (dayOfWeek === 0 || dayOfWeek === 6) {
                                const fridayBefore = new Date(dueDate);
                                fridayBefore.setDate(dueDate.getDate() - (dayOfWeek === 0 ? 2 : 1));
                                const fridayDiff = Math.ceil((fridayBefore - today) / (1000 * 60 * 60 * 24));
                                if (fridayDiff <= reminder.advanceDays) {
                                    reminder.urgency = diffDays <= 1 ? 'urgent' : 'warning';
                                    return true;
                                }
                            } else {
                                reminder.urgency = diffDays <= 1 ? 'urgent' : 'warning';
                                return true;
                            }
                        }
                        return false;
                    });
                });
                
                // æ™ºèƒ½åˆ†æè¨ˆç®—
                const incomeTrend = computed(() => {
                    const thisMonth = records.value.filter(r => 
                        r.type === 'income' && 
                        new Date(r.date).getMonth() === new Date().getMonth()
                    ).reduce((sum, r) => sum + r.amount, 0);
                    
                    const lastMonth = records.value.filter(r => 
                        r.type === 'income' && 
                        new Date(r.date).getMonth() === new Date().getMonth() - 1
                    ).reduce((sum, r) => sum + r.amount, 0);
                    
                    const percentage = lastMonth > 0 ? ((thisMonth - lastMonth) / lastMonth * 100).toFixed(1) : 0;
                    return {
                        direction: thisMonth >= lastMonth ? 'up' : 'down',
                        percentage: Math.abs(percentage)
                    };
                });
                
                const expenseTrend = computed(() => {
                    const thisMonth = records.value.filter(r => 
                        r.type === 'expense' && 
                        new Date(r.date).getMonth() === new Date().getMonth()
                    ).reduce((sum, r) => sum + r.amount, 0);
                    
                    const lastMonth = records.value.filter(r => 
                        r.type === 'expense' && 
                        new Date(r.date).getMonth() === new Date().getMonth() - 1
                    ).reduce((sum, r) => sum + r.amount, 0);
                    
                    const percentage = lastMonth > 0 ? ((thisMonth - lastMonth) / lastMonth * 100).toFixed(1) : 0;
                    return {
                        direction: thisMonth >= lastMonth ? 'up' : 'down',
                        percentage: Math.abs(percentage)
                    };
                });
                
                const balanceTrend = computed(() => {
                    const thisMonthBalance = totalIncome.value - totalExpense.value;
                    const lastMonthIncome = records.value.filter(r => 
                        r.type === 'income' && 
                        new Date(r.date).getMonth() === new Date().getMonth() - 1
                    ).reduce((sum, r) => sum + r.amount, 0);
                    
                    const lastMonthExpense = records.value.filter(r => 
                        r.type === 'expense' && 
                        new Date(r.date).getMonth() === new Date().getMonth() - 1
                    ).reduce((sum, r) => sum + r.amount, 0);
                    
                    const lastMonthBalance = lastMonthIncome - lastMonthExpense;
                    const percentage = lastMonthBalance !== 0 ? ((thisMonthBalance - lastMonthBalance) / Math.abs(lastMonthBalance) * 100).toFixed(1) : 0;
                    
                    return {
                        direction: thisMonthBalance >= lastMonthBalance ? 'up' : 'down',
                        percentage: Math.abs(percentage)
                    };
                });
                
                const healthScore = computed(() => {
                    let score = 50; // åŸºç¤åˆ†æ•¸
                    
                    // æ”¶æ”¯æ¯”ä¾‹è©•åˆ†
                    const ratio = totalExpense.value > 0 ? totalIncome.value / totalExpense.value : 1;
                    if (ratio > 1.5) score += 30;
                    else if (ratio > 1.2) score += 20;
                    else if (ratio > 1) score += 10;
                    else score -= 20;
                    
                    // çµé¤˜ç©©å®šæ€§è©•åˆ†
                    if (totalBalance.value > 0) score += 20;
                    else score -= 30;
                    
                    return Math.max(0, Math.min(100, score));
                });
                
                const healthStatus = computed(() => {
                    if (healthScore.value >= 80) return 'å„ªç§€';
                    if (healthScore.value >= 60) return 'è‰¯å¥½';
                    if (healthScore.value >= 40) return 'ä¸€èˆ¬';
                    return 'éœ€æ”¹å–„';
                });
                
                const incomeExpenseRatio = computed(() => {
                    return totalExpense.value > 0 ? (totalIncome.value / totalExpense.value * 100).toFixed(1) : 100;
                });
                
                const incomeExpenseAnalysis = computed(() => {
                    const ratio = parseFloat(incomeExpenseRatio.value);
                    if (ratio > 150) return 'æ”¶å…¥é è¶…æ”¯å‡ºï¼Œè²¡å‹™ç‹€æ³å„ªç§€';
                    if (ratio > 120) return 'æ”¶å…¥è¶…éæ”¯å‡ºï¼Œè²¡å‹™ç‹€æ³è‰¯å¥½';
                    if (ratio > 100) return 'æ”¶å…¥ç•¥è¶…æ”¯å‡ºï¼Œéœ€æ³¨æ„æ§åˆ¶';
                    return 'æ”¯å‡ºè¶…éæ”¶å…¥ï¼Œéœ€è¦èª¿æ•´è²¡å‹™';
                });
                
                const avgDailyIncome = computed(() => {
                    const days = Math.max(1, Math.ceil((new Date() - new Date(new Date().getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24)));
                    return totalIncome.value / days;
                });
                
                const avgIncomeAnalysis = computed(() => {
                    if (avgDailyIncome.value > 1000) return 'æ—¥å‡æ”¶å…¥è¡¨ç¾å„ªç§€';
                    if (avgDailyIncome.value > 500) return 'æ—¥å‡æ”¶å…¥è¡¨ç¾è‰¯å¥½';
                    if (avgDailyIncome.value > 200) return 'æ—¥å‡æ”¶å…¥è¡¨ç¾ä¸€èˆ¬';
                    return 'å»ºè­°å¢åŠ æ”¶å…¥ä¾†æº';
                });
                
                const topExpenseCategory = computed(() => {
                    const categoryStats = {};
                    filteredRecords.value.filter(r => r.type === 'expense').forEach(record => {
                        categoryStats[record.category] = (categoryStats[record.category] || 0) + record.amount;
                    });
                    
                    const sortedCategories = Object.entries(categoryStats).sort((a, b) => b[1] - a[1]);
                    if (sortedCategories.length === 0) return { name: 'ç„¡', percentage: 0 };
                    
                    const topCategory = sortedCategories[0];
                    const percentage = totalExpense.value > 0 ? (topCategory[1] / totalExpense.value * 100).toFixed(1) : 0;
                    
                    return {
                        name: topCategory[0],
                        percentage: percentage
                    };
                });
                
                const predictedBalance = computed(() => {
                    const monthlyIncome = totalIncome.value;
                    const monthlyExpense = totalExpense.value;
                    const trend = monthlyIncome - monthlyExpense;
                    return totalBalance.value + trend;
                });
                
                const balancePrediction = computed(() => {
                    const predicted = predictedBalance.value;
                    if (predicted > totalBalance.value) return 'é è¨ˆä¸‹æœˆçµé¤˜å¢åŠ ';
                    if (predicted < totalBalance.value) return 'é è¨ˆä¸‹æœˆçµé¤˜æ¸›å°‘';
                    return 'é è¨ˆä¸‹æœˆçµé¤˜æŒå¹³';
                });
                
                const financialSuggestions = computed(() => {
                    const suggestions = [];
                    
                    if (totalExpense.value > totalIncome.value) {
                        suggestions.push({
                            id: 1,
                            title: 'æ”¯å‡ºæ§åˆ¶å»ºè­°',
                            description: 'ç•¶å‰æ”¯å‡ºè¶…éæ”¶å…¥ï¼Œå»ºè­°æª¢è¦–ä¸¦å‰Šæ¸›éå¿…è¦æ”¯å‡ºé …ç›®ï¼Œç‰¹åˆ¥æ˜¯é›œé …é–‹æ”¯å’Œç®¡ç†è²»ç”¨ã€‚'
                        });
                    }
                    
                    if (topExpenseCategory.value.percentage > 50) {
                        suggestions.push({
                            id: 2,
                            title: 'æ”¯å‡ºçµæ§‹å„ªåŒ–',
                            description: `${topExpenseCategory.value.name}ä½”æ”¯å‡ºæ¯”ä¾‹éé«˜ï¼ˆ${topExpenseCategory.value.percentage}%ï¼‰ï¼Œå»ºè­°åˆ†æ•£æ”¯å‡ºé¢¨éšªï¼Œé¿å…éåº¦ä¾è³´å–®ä¸€æ”¯å‡ºé¡åˆ¥ã€‚`
                        });
                    }
                    
                    if (healthScore.value < 60) {
                        suggestions.push({
                            id: 3,
                            title: 'è²¡å‹™å¥åº·æ”¹å–„',
                            description: 'è²¡å‹™å¥åº·åº¦åä½ï¼Œå»ºè­°ï¼š1) å¢åŠ é¦™æ²¹éŒ¢ç­‰ç©©å®šæ”¶å…¥ä¾†æº 2) æ§åˆ¶äººå“¡è–ªæ°´å’Œæˆ¿ç§Ÿç­‰å›ºå®šæ”¯å‡º 3) å»ºç«‹ç·Šæ€¥å‚™ç”¨é‡‘ã€‚'
                        });
                    }
                    
                    const incomeVariance = calculateIncomeVariance();
                    if (incomeVariance > 0.5) {
                        suggestions.push({
                            id: 4,
                            title: 'æ”¶å…¥ç©©å®šæ€§æå‡',
                            description: 'æ”¶å…¥æ³¢å‹•è¼ƒå¤§ï¼Œå»ºè­°å¤šå…ƒåŒ–æ”¶å…¥ä¾†æºï¼Œå¦‚å¢åŠ å…‰æ˜ç‡ˆã€çœ‹é¢¨æ°´ç­‰æœå‹™é …ç›®ï¼Œæ¸›å°‘å°å–®ä¸€æ”¶å…¥çš„ä¾è³´ã€‚'
                        });
                    }
                    
                    if (suggestions.length === 0) {
                        suggestions.push({
                            id: 5,
                            title: 'è²¡å‹™ç‹€æ³è‰¯å¥½',
                            description: 'ç›®å‰è²¡å‹™ç‹€æ³ç©©å®šï¼Œå»ºè­°ç¹¼çºŒä¿æŒè‰¯å¥½çš„æ”¶æ”¯ç®¡ç†ç¿’æ…£ï¼Œå¯è€ƒæ…®è¨­ç«‹ç™¼å±•åŸºé‡‘ç‚ºæœªä¾†æ“´å±•åšæº–å‚™ã€‚'
                        });
                    }
                    
                    return suggestions;
                });
                
                // é ç®—ç›¸é—œè¨ˆç®—å±¬æ€§
                const budgetSummary = computed(() => {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const monthBudgets = budgets.value[currentMonth] || {};
                    
                    const summary = expenseCategories.map(category => {
                        const budget = monthBudgets[category] || 0;
                        const spent = records.value
                            .filter(r => r.type === 'expense' && r.category === category && r.date.startsWith(currentMonth))
                            .reduce((sum, r) => sum + r.amount, 0);
                        
                        const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                        
                        return {
                            category,
                            budget,
                            spent,
                            remaining: budget - spent,
                            percentage
                        };
                    });
                    
                    return summary;
                });
                
                const totalBudget = computed(() => {
                    return budgetSummary.value.reduce((sum, item) => sum + item.budget, 0);
                });
                
                const totalExpenseForMonth = computed(() => {
                    return budgetSummary.value.reduce((sum, item) => sum + item.spent, 0);
                });
                
                const remainingBudget = computed(() => {
                    return totalBudget.value - totalExpenseForMonth.value;
                });
                
                const budgetStatus = computed(() => {
                    if (totalBudget.value === 0) return 'å°šæœªè¨­å®šé ç®—';
                    const percentage = (totalExpenseForMonth.value / totalBudget.value) * 100;
                    if (percentage > 100) return `å·²è¶…æ”¯ ${((percentage - 100).toFixed(1))}%`;
                    return `å‰©é¤˜ ${(100 - percentage).toFixed(1)}%`;
                });
                
                // è¨ˆç®—æ”¶å…¥è®Šç•°ä¿‚æ•¸
                const calculateIncomeVariance = () => {
                    const monthlyIncomes = {};
                    filteredRecords.value.filter(r => r.type === 'income').forEach(record => {
                        const month = new Date(record.date).toISOString().slice(0, 7);
                        monthlyIncomes[month] = (monthlyIncomes[month] || 0) + record.amount;
                    });
                    
                    const incomes = Object.values(monthlyIncomes);
                    if (incomes.length < 2) return 0;
                    
                    const mean = incomes.reduce((a, b) => a + b, 0) / incomes.length;
                    const variance = incomes.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / incomes.length;
                    const stdDev = Math.sqrt(variance);
                    
                    return mean > 0 ? stdDev / mean : 0;
                };
                
                // æ–¹æ³•
                const formatCurrency = (amount) => {
                    return new Intl.NumberFormat('zh-TW', {
                        style: 'currency',
                        currency: 'TWD',
                        minimumFractionDigits: 0
                    }).format(amount);
                };
                
                const formatDate = (date) => {
                    return new Date(date).toLocaleDateString('zh-TW');
                };
                
                const formatReminderDate = (date) => {
                    const dueDate = new Date(date);
                    const today = new Date();
                    const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        return `å·²éæœŸ ${Math.abs(diffDays)} å¤©`;
                    } else if (diffDays === 0) {
                        return 'ä»Šå¤©åˆ°æœŸ';
                    } else if (diffDays === 1) {
                        return 'æ˜å¤©åˆ°æœŸ';
                    } else {
                        return `${diffDays} å¤©å¾Œåˆ°æœŸ (${formatDate(date)})`;
                    }
                };
                
                const switchPage = (page) => {
                    document.querySelectorAll('.page-content').forEach(el => {
                        el.classList.remove('active');
                    });
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    document.getElementById(page).classList.add('active');
                    event.currentTarget.classList.add('active');
                    
                    currentPage.value = page;
                    
                    // åˆå§‹åŒ–åœ–è¡¨
                    if (page === 'analysis') {
                        nextTick(() => {
                            initAnalysisCharts();
                        });
                    } else if (page === 'dashboard') {
                        nextTick(() => {
                            initDashboardChart();
                        });
                    }
                };
                
                const openAddModal = (type) => {
                    form.value.type = type;
                    form.value.category = '';
                    showAddModal.value = true;
                };
                
                const closeAddModal = () => {
                    showAddModal.value = false;
                    resetForm();
                };
                
                const resetForm = () => {
                    form.value = {
                        type: 'income',
                        category: '',
                        amount: null,
                        date: new Date().toISOString().split('T')[0],
                        description: '',
                        donor: ''
                    };
                };
                
                const updateCategories = () => {
                    form.value.category = '';
                };
                
                const saveRecord = async () => {
                    if (!form.value.category || !form.value.amount) {
                        alert('è«‹å¡«å¯«å¿…è¦æ¬„ä½');
                        return;
                    }
                    
                    // é ç®—æª¢æŸ¥
                    if (form.value.type === 'expense') {
                        const currentMonth = form.value.date.slice(0, 7);
                        const monthBudgets = budgets.value[currentMonth] || {};
                        const categoryBudget = monthBudgets[form.value.category] || 0;
                        
                        if (categoryBudget > 0) {
                            const spent = records.value
                                .filter(r => r.type === 'expense' && r.category === form.value.category && r.date.startsWith(currentMonth))
                                .reduce((sum, r) => sum + r.amount, 0);
                            
                            if (spent + form.value.amount > categoryBudget) {
                                if (!confirm(`æ­¤ç­†æ”¯å‡ºå°‡è¶…é [${form.value.category}] çš„é ç®—ï¼\n\né ç®—: ${formatCurrency(categoryBudget)}\nå·²ç”¨: ${formatCurrency(spent)}\næ­¤ç­†: ${formatCurrency(form.value.amount)}\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                                    return;
                                }
                            }
                        }
                    }
                    
                    const newRecord = {
                        type: form.value.type,
                        category: form.value.category,
                        amount: form.value.amount,
                        date: form.value.date,
                        description: form.value.description || form.value.category,
                        donor: form.value.donor || '',
                        createdAt: new Date().toISOString()
                    };
                    
                    await db.records.add(newRecord);
                    
                    // æ›´æ–°ä¿¡çœ¾è³‡æ–™
                    if (form.value.type === 'income' && form.value.donor) {
                        await updateDonor(form.value.donor, form.value.amount, form.value.date);
                    }
                    
                    await loadFromDB();
                    closeAddModal();
                    
                    showNotification('è¨˜éŒ„å·²å„²å­˜', 'æ”¶æ”¯è¨˜éŒ„å·²æˆåŠŸæ–°å¢');
                    
                    // æ›´æ–°åœ–è¡¨
                    if (currentPage.value === 'dashboard') {
                        nextTick(() => {
                            initDashboardChart();
                        });
                    } else if (currentPage.value === 'analysis') {
                        nextTick(() => {
                            initAnalysisCharts();
                        });
                    }
                };
                
                const saveReminder = async () => {
                    if (!reminderForm.value.title || !reminderForm.value.dueDate) {
                        alert('è«‹å¡«å¯«å¿…è¦æ¬„ä½');
                        return;
                    }
                    
                    if (editingReminder.value) {
                        await db.reminders.update(editingReminder.value.id, {
                            ...reminderForm.value,
                            updatedAt: new Date().toISOString()
                        });
                    } else {
                        await db.reminders.add({
                            ...reminderForm.value,
                            completed: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    await loadFromDB();
                    closeReminderModal();
                    
                    showNotification('æé†’å·²å„²å­˜', 'æé†’è¨­å®šå·²æˆåŠŸå„²å­˜');
                };
                
                const closeReminderModal = () => {
                    showReminderModal.value = false;
                    editingReminder.value = null;
                    resetReminderForm();
                };
                
                const resetReminderForm = () => {
                    reminderForm.value = {
                        title: '',
                        description: '',
                        dueDate: '',
                        repeat: 'none',
                        advanceDays: 2
                    };
                };
                
                const editReminder = (reminder) => {
                    editingReminder.value = reminder;
                    reminderForm.value = { ...reminder };
                    showReminderModal.value = true;
                };
                
                const markReminderDone = async (id) => {
                    const reminder = await db.reminders.get(id);
                    if (reminder) {
                        await db.reminders.update(id, {
                            completed: true,
                            completedAt: new Date().toISOString()
                        });
                        
                        if (reminder.repeat !== 'none') {
                            const nextDueDate = new Date(reminder.dueDate);
                            if (reminder.repeat === 'monthly') {
                                nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                            } else if (reminder.repeat === 'yearly') {
                                nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                            }
                            
                            await db.reminders.add({
                                ...reminder,
                                id: undefined,
                                dueDate: nextDueDate.toISOString().split('T')[0],
                                completed: false,
                                createdAt: new Date().toISOString()
                            });
                        }
                        
                        await loadFromDB();
                        showNotification('æé†’å·²å®Œæˆ', 'æé†’å·²æ¨™è¨˜ç‚ºå®Œæˆ');
                    }
                };
                
                const snoozeReminder = async (id) => {
                    const reminder = await db.reminders.get(id);
                    if (reminder) {
                        const newDueDate = new Date(reminder.dueDate);
                        newDueDate.setDate(newDueDate.getDate() + 1);
                        await db.reminders.update(id, {
                            dueDate: newDueDate.toISOString().split('T')[0]
                        });
                        await loadFromDB();
                        showNotification('æé†’å·²å»¶å¾Œ', 'æé†’å·²å»¶å¾Œä¸€å¤©');
                    }
                };
                
                const deleteReminder = async (id) => {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æé†’å—ï¼Ÿ')) {
                        await db.reminders.delete(id);
                        await loadFromDB();
                        showNotification('æé†’å·²åˆªé™¤', 'æé†’å·²æˆåŠŸåˆªé™¤');
                    }
                };
                
                const showNotifications = () => {
                    if (urgentReminders.value.length > 0) {
                        switchPage('reminders');
                    } else {
                        showNotification('ç„¡ç·Šæ€¥æé†’', 'ç›®å‰æ²’æœ‰éœ€è¦è™•ç†çš„æé†’');
                    }
                };
                
                const showNotification = (title, message) => {
                    currentNotification.value = { title, message };
                    showNotificationPopup.value = true;
                    setTimeout(() => {
                        showNotificationPopup.value = false;
                    }, 3000);
                };
                
                const loadFromDB = async () => {
                    const [recordsData, remindersData, budgetsData, donorsData] = await Promise.all([
                        db.records.toArray(),
                        db.reminders.toArray(),
                        db.budgets.toArray(),
                        db.donors.toArray()
                    ]);
                    
                    records.value = recordsData;
                    reminders.value = remindersData;
                    donors.value = donorsData;
                    
                    const budgetObject = {};
                    budgetsData.forEach(item => {
                        budgetObject[item.month] = item.data;
                    });
                    budgets.value = budgetObject;
                };
                
                const saveToDB = async () => {
                    // Records and Reminders are saved individually
                    // Save budgets
                    for (const month in budgets.value) {
                        await db.budgets.put({ month, data: budgets.value[month] });
                    }
                };
                
                const openBudgetModal = (category, amount) => {
                    budgetForm.value.category = category;
                    budgetForm.value.amount = amount;
                    showBudgetModal.value = true;
                };
                
                const saveBudget = async () => {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    if (!budgets.value[currentMonth]) {
                        budgets.value[currentMonth] = {};
                    }
                    budgets.value[currentMonth][budgetForm.value.category] = budgetForm.value.amount;
                    await db.budgets.put({ month: currentMonth, data: budgets.value[currentMonth] });
                    showBudgetModal.value = false;
                    showNotification('é ç®—å·²è¨­å®š', `${budgetForm.value.category} çš„é ç®—å·²æ›´æ–°`);
                };
                
                const copyLastMonthBudget = async () => {
                    const today = new Date();
                    const currentMonth = today.toISOString().slice(0, 7);
                    const lastMonthDate = new Date(today.setMonth(today.getMonth() - 1));
                    const lastMonth = lastMonthDate.toISOString().slice(0, 7);
                    
                    const lastMonthBudgetData = await db.budgets.get(lastMonth);
                    
                    if (lastMonthBudgetData) {
                        if (confirm('ç¢ºå®šè¦å°‡ä¸Šå€‹æœˆçš„é ç®—è¤‡è£½åˆ°æœ¬æœˆå—ï¼Ÿé€™å°‡æœƒè¦†è“‹æœ¬æœˆå·²è¨­å®šçš„é ç®—ã€‚')) {
                            budgets.value[currentMonth] = { ...lastMonthBudgetData.data };
                            await db.budgets.put({ month: currentMonth, data: budgets.value[currentMonth] });
                            showNotification('é ç®—å·²è¤‡è£½', 'å·²æˆåŠŸè¤‡è£½ä¸Šå€‹æœˆçš„é ç®—');
                        }
                    } else {
                        alert('ä¸Šå€‹æœˆæ²’æœ‰è¨­å®šé ç®—');
                    }
                };
                
                const updateDonor = async (name, amount, date) => {
                    const existingDonor = await db.donors.get(name);
                    if (existingDonor) {
                        await db.donors.update(name, {
                            totalDonation: existingDonor.totalDonation + amount,
                            donationCount: existingDonor.donationCount + 1,
                            lastDonationDate: date
                        });
                    } else {
                        await db.donors.add({
                            name,
                            totalDonation: amount,
                            donationCount: 1,
                            lastDonationDate: date
                        });
                    }
                };
                
                const showDonorDetails = (donor) => {
                    selectedDonor.value = donor;
                };
                
                const getDonorRecords = (donorName) => {
                    return records.value.filter(r => r.donor === donorName).sort((a, b) => new Date(b.date) - new Date(a.date));
                };
                
                const exportData = () => {
                    if (records.value.length === 0) {
                        alert('æš«ç„¡è³‡æ–™å¯åŒ¯å‡º');
                        return;
                    }
                    
                    const csvContent = [
                        'æ—¥æœŸ,é¡å‹,é¡åˆ¥,é‡‘é¡,èªªæ˜,ææ¬¾äºº',
                        ...records.value.map(record => [
                            record.date,
                            record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                            record.category,
                            record.amount,
                            record.description,
                            record.donor || ''
                        ].join(','))
                    ].join('\n');
                    
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `å»£æ¸…å®®è¨˜å¸³è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('åŒ¯å‡ºæˆåŠŸ', 'è³‡æ–™å·²åŒ¯å‡ºç‚ºCSVæª”æ¡ˆ');
                };
                
                const generateTestData = async () => {
                    if (confirm('ç¢ºå®šè¦ç”Ÿæˆæ¸¬è©¦è³‡æ–™å—ï¼Ÿé€™å°‡æœƒæ–°å¢ä¸€äº›ç¤ºä¾‹è¨˜éŒ„ã€‚')) {
                        const testRecords = [];
                        const today = new Date();
                        
                        // ç”Ÿæˆéå»3å€‹æœˆçš„æ¸¬è©¦è³‡æ–™
                        for (let i = 0; i < 90; i++) {
                            const date = new Date(today);
                            date.setDate(date.getDate() - i);
                            
                            // éš¨æ©Ÿç”Ÿæˆæ”¶å…¥è¨˜éŒ„
                            if (Math.random() > 0.7) {
                                const incomeCategory = incomeCategories[Math.floor(Math.random() * incomeCategories.length)];
                                const donorName = Math.random() > 0.5 ? `ä¿¡çœ¾${Math.floor(Math.random() * 100)}` : '';
                                const amount = Math.floor(Math.random() * 5000) + 500;
                                
                                testRecords.push({
                                    type: 'income',
                                    category: incomeCategory,
                                    amount: amount,
                                    date: date.toISOString().split('T')[0],
                                    description: `${incomeCategory}æ”¶å…¥`,
                                    donor: donorName,
                                    createdAt: new Date().toISOString()
                                });
                                
                                if (donorName) {
                                    await updateDonor(donorName, amount, date.toISOString().split('T')[0]);
                                }
                            }
                            
                            // éš¨æ©Ÿç”Ÿæˆæ”¯å‡ºè¨˜éŒ„
                            if (Math.random() > 0.8) {
                                const expenseCategory = expenseCategories[Math.floor(Math.random() * expenseCategories.length)];
                                testRecords.push({
                                    type: 'expense',
                                    category: expenseCategory,
                                    amount: Math.floor(Math.random() * 3000) + 200,
                                    date: date.toISOString().split('T')[0],
                                    description: `${expenseCategory}æ”¯å‡º`,
                                    donor: '',
                                    createdAt: new Date().toISOString()
                                });
                            }
                        }
                        
                        await db.records.bulkAdd(testRecords);
                        await loadFromDB();
                        showNotification('æ¸¬è©¦è³‡æ–™å·²ç”Ÿæˆ', `å·²æ–°å¢ ${testRecords.length} ç­†æ¸¬è©¦è¨˜éŒ„`);
                        
                        // æ›´æ–°åœ–è¡¨
                        if (currentPage.value === 'dashboard') {
                            nextTick(() => {
                                initDashboardChart();
                            });
                        } else if (currentPage.value === 'analysis') {
                            nextTick(() => {
                                initAnalysisCharts();
                            });
                        }
                    }
                };
                
                const clearAllData = async () => {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                        await db.delete();
                        db.open();
                        await loadFromDB();
                        showNotification('è³‡æ–™å·²æ¸…é™¤', 'æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¸…é™¤');
                        
                        // æ›´æ–°åœ–è¡¨
                        if (currentPage.value === 'dashboard') {
                            nextTick(() => {
                                initDashboardChart();
                            });
                        } else if (currentPage.value === 'analysis') {
                            nextTick(() => {
                                initAnalysisCharts();
                            });
                        }
                    }
                };
                
                const installApp = () => {
                    if ('serviceWorker' in navigator) {
                        showNotification('å®‰è£æç¤º', 'è«‹ä½¿ç”¨ç€è¦½å™¨çš„ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€åŠŸèƒ½å®‰è£æ­¤æ‡‰ç”¨');
                    } else {
                        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´PWAå®‰è£åŠŸèƒ½');
                    }
                };
                
                const checkReminders = () => {
                    if (urgentReminders.value.length > 0) {
                        const reminder = urgentReminders.value[0];
                        showNotification('æé†’é€šçŸ¥', `${reminder.title} - ${formatReminderDate(reminder.dueDate)}`);
                    }
                };
                
                // åœ–è¡¨åˆå§‹åŒ–
                const initDashboardChart = () => {
                    const chartElement = document.getElementById('dashboardChart');
                    if (!chartElement) return;
                    
                    const chart = echarts.init(chartElement);
                    
                    // æº–å‚™æ•¸æ“š
                    const last7Days = [];
                    const incomeData = [];
                    const expenseData = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        last7Days.push(date.getMonth() + 1 + '/' + date.getDate());
                        
                        const dayIncome = records.value
                            .filter(r => r.type === 'income' && r.date === dateStr)
                            .reduce((sum, r) => sum + r.amount, 0);
                        const dayExpense = records.value
                            .filter(r => r.type === 'expense' && r.date === dateStr)
                            .reduce((sum, r) => sum + r.amount, 0);
                        
                        incomeData.push(dayIncome);
                        expenseData.push(dayExpense);
                    }
                    
                    const option = {
                        title: {
                            text: 'è¿‘7å¤©æ”¶æ”¯è¶¨å‹¢',
                            left: 'center'
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                let result = params[0].name + '<br/>';
                                params.forEach(param => {
                                    result += param.marker + param.seriesName + ': ' + formatCurrency(param.value) + '<br/>';
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['æ”¶å…¥', 'æ”¯å‡º'],
                            top: 30
                        },
                        xAxis: {
                            type: 'category',
                            data: last7Days
                        },
                        yAxis: {
                            type: 'value',
                            axisLabel: {
                                formatter: function(value) {
                                    return value >= 1000 ? (value / 1000) + 'K' : value;
                                }
                            }
                        },
                        series: [
                            {
                                name: 'æ”¶å…¥',
                                type: 'line',
                                data: incomeData,
                                itemStyle: { color: '#67c23a' },
                                smooth: true
                            },
                            {
                                name: 'æ”¯å‡º',
                                type: 'line',
                                data: expenseData,
                                itemStyle: { color: '#f56c6c' },
                                smooth: true
                            }
                        ]
                    };
                    
                    chart.setOption(option);
                    
                    window.addEventListener('resize', () => {
                        chart.resize();
                    });
                };
                
                const initAnalysisCharts = () => {
                    // è¶¨å‹¢åœ–
                    const trendElement = document.getElementById('trendChart');
                    if (trendElement) {
                        const chart = echarts.init(trendElement);
                        
                        // æœˆåº¦æ•¸æ“š
                        const monthlyData = {};
                        filteredRecords.value.forEach(record => {
                            const month = new Date(record.date).toISOString().slice(0, 7);
                            if (!monthlyData[month]) {
                                monthlyData[month] = { income: 0, expense: 0 };
                            }
                            monthlyData[month][record.type] += record.amount;
                        });
                        
                        const months = Object.keys(monthlyData).sort();
                        const incomeData = months.map(month => monthlyData[month].income);
                        const expenseData = months.map(month => monthlyData[month].expense);
                        
                        const option = {
                            title: {
                                text: 'æœˆåº¦æ”¶æ”¯è¶¨å‹¢',
                                left: 'center'
                            },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    let result = params[0].name + '<br/>';
                                    params.forEach(param => {
                                        result += param.marker + param.seriesName + ': ' + formatCurrency(param.value) + '<br/>';
                                    });
                                    return result;
                                }
                            },
                            legend: {
                                data: ['æ”¶å…¥', 'æ”¯å‡º'],
                                top: 30
                            },
                            xAxis: {
                                type: 'category',
                                data: months
                            },
                            yAxis: {
                                type: 'value',
                                axisLabel: {
                                    formatter: function(value) {
                                        return value >= 1000 ? (value / 1000) + 'K' : value;
                                    }
                                }
                            },
                            series: [
                                {
                                    name: 'æ”¶å…¥',
                                    type: 'bar',
                                    data: incomeData,
                                    itemStyle: { color: '#67c23a' }
                                },
                                {
                                    name: 'æ”¯å‡º',
                                    type: 'bar',
                                    data: expenseData,
                                    itemStyle: { color: '#f56c6c' }
                                }
                            ]
                        };
                        
                        chart.setOption(option);
                    }
                    
                    // é¡åˆ¥åˆ†æåœ–
                    const categoryElement = document.getElementById('categoryChart');
                    if (categoryElement) {
                        const chart = echarts.init(categoryElement);
                        
                        const categoryStats = {};
                        filteredRecords.value.filter(r => r.type === 'expense').forEach(record => {
                            categoryStats[record.category] = (categoryStats[record.category] || 0) + record.amount;
                        });
                        
                        const categoryData = Object.entries(categoryStats).map(([name, value]) => ({
                            name,
                            value
                        }));
                        
                        const option = {
                            title: {
                                text: 'æ”¯å‡ºé¡åˆ¥åˆ†å¸ƒ',
                                left: 'center'
                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c} ({d}%)'
                            },
                            series: [
                                {
                                    name: 'æ”¯å‡ºé¡åˆ¥',
                                    type: 'pie',
                                    radius: '50%',
                                    data: categoryData,
                                    emphasis: {
                                        itemStyle: {
                                            shadowBlur: 10,
                                            shadowOffsetX: 0,
                                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                                        }
                                    }
                                }
                            ]
                        };
                        
                        chart.setOption(option);
                    }
                    
                    // æœˆåº¦å°æ¯”åœ–
                    const monthlyElement = document.getElementById('monthlyChart');
                    if (monthlyElement) {
                        const chart = echarts.init(monthlyElement);
                        
                        const currentYear = new Date().getFullYear();
                        const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                        const monthlyIncome = new Array(12).fill(0);
                        const monthlyExpense = new Array(12).fill(0);
                        
                        records.value.forEach(record => {
                            const recordDate = new Date(record.date);
                            if (recordDate.getFullYear() === currentYear) {
                                const month = recordDate.getMonth();
                                if (record.type === 'income') {
                                    monthlyIncome[month] += record.amount;
                                } else {
                                    monthlyExpense[month] += record.amount;
                                }
                            }
                        });
                        
                        const option = {
                            title: {
                                text: `${currentYear}å¹´æœˆåº¦æ”¶æ”¯å°æ¯”`,
                                left: 'center'
                            },
                            tooltip: {
                                trigger: 'axis',
                                formatter: function(params) {
                                    let result = params[0].name + '<br/>';
                                    params.forEach(param => {
                                        result += param.marker + param.seriesName + ': ' + formatCurrency(param.value) + '<br/>';
                                    });
                                    return result;
                                }
                            },
                            legend: {
                                data: ['æ”¶å…¥', 'æ”¯å‡º'],
                                top: 30
                            },
                            xAxis: {
                                type: 'category',
                                data: monthNames
                            },
                            yAxis: {
                                type: 'value',
                                axisLabel: {
                                    formatter: function(value) {
                                        return value >= 1000 ? (value / 1000) + 'K' : value;
                                    }
                                }
                            },
                            series: [
                                {
                                    name: 'æ”¶å…¥',
                                    type: 'line',
                                    data: monthlyIncome,
                                    itemStyle: { color: '#67c23a' },
                                    smooth: true,
                                    areaStyle: { opacity: 0.3 }
                                },
                                {
                                    name: 'æ”¯å‡º',
                                    type: 'line',
                                    data: monthlyExpense,
                                    itemStyle: { color: '#f56c6c' },
                                    smooth: true,
                                    areaStyle: { opacity: 0.3 }
                                }
                            ]
                        };
                        
                        chart.setOption(option);
                    }
                };
                
                const updateCharts = () => {
                    if (currentPage.value === 'analysis') {
                        nextTick(() => {
                            initAnalysisCharts();
                        });
                    }
                };
                
                // ç”Ÿå‘½é€±æœŸ
                onMounted(() => {
                    loadFromDB();
                    
                    // è¨»å†Š Service Worker
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('./service-worker.js')
                            .then(registration => {
                                console.log('SW registered: ', registration);
                            })
                            .catch(registrationError => {
                                console.log('SW registration failed: ', registrationError);
                            });
                    }
                    
                    // æª¢æŸ¥æé†’
                    checkReminders();
                    
                    // æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡æé†’
                    setInterval(checkReminders, 60 * 60 * 1000);
                    
                    // åˆå§‹åŒ–åœ–è¡¨
                    nextTick(() => {
                        initDashboardChart();
                    });
                    
                    // æ·»åŠ ç¤ºä¾‹æé†’
                    if (reminders.value.length === 0) {
                        const today = new Date();
                        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 25);
                        
                        db.reminders.add({
                            title: 'ç¹³æˆ¿ç§Ÿ',
                            description: 'æ¯æœˆ25è™Ÿè¦ç¹³æˆ¿ç§Ÿçµ¦æˆ¿æ±',
                            dueDate: nextMonth.toISOString().split('T')[0],
                            repeat: 'monthly',
                            advanceDays: 2,
                            completed: false,
                            createdAt: new Date().toISOString()
                        }).then(loadFromDB);
                    }
                });
                
                return {
                    showAddModal,
                    showReminderModal,
                    showBudgetModal,
                    showNotificationPopup,
                    currentPage,
                    records,
                    reminders,
                    budgets,
                    donors,
                    form,
                    reminderForm,
                    budgetForm,
                    editingReminder,
                    currentNotification,
                    selectedTimeFilter,
                    timeFilters,
                    donorSearchQuery,
                    filteredDonors,
                    selectedDonor,
                    currentCategories,
                    modalTitle,
                    reminderModalTitle,
                    totalIncome,
                    totalExpense,
                    totalBalance,
                    recentRecords,
                    allReminders,
                    urgentReminders,
                    incomeTrend,
                    expenseTrend,
                    balanceTrend,
                    healthScore,
                    healthStatus,
                    incomeExpenseRatio,
                    incomeExpenseAnalysis,
                    avgDailyIncome,
                    avgIncomeAnalysis,
                    topExpenseCategory,
                    predictedBalance,
                    balancePrediction,
                    financialSuggestions,
                    budgetSummary,
                    totalBudget,
                    totalExpenseForMonth,
                    remainingBudget,
                    budgetStatus,
                    formatCurrency,
                    formatDate,
                    formatReminderDate,
                    switchPage,
                    openAddModal,
                    closeAddModal,
                    updateCategories,
                    saveRecord,
                    saveReminder,
                    closeReminderModal,
                    editReminder,
                    markReminderDone,
                    snoozeReminder,
                    deleteReminder,
                    showNotifications,
                    openBudgetModal,
                    saveBudget,
                    copyLastMonthBudget,
                    showDonorDetails,
                    getDonorRecords,
                    exportData,
                    generateTestData,
                    clearAllData,
                    installApp,
                    updateCharts
                };
            }
        }).mount('#app');
    </script>
</body>
</html>