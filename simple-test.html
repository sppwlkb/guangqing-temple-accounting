<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–®åŒæ­¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { opacity: 0.8; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ”§ ç°¡å–®åŒæ­¥æ¸¬è©¦</h1>
        <p>é€™æ˜¯ä¸€å€‹ç¨ç«‹çš„æ¸¬è©¦å·¥å…·ï¼Œä¸ä¾è³´å…¶ä»–è…³æœ¬ã€‚</p>
        <button class="btn" onclick="runTest()">é–‹å§‹æ¸¬è©¦</button>
        <button class="btn" onclick="clearCache()">æ¸…é™¤å¿«å–</button>
    </div>
    
    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const card = document.createElement('div');
            card.className = `card ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            card.innerHTML = `
                <strong>[${timestamp}] ${type.toUpperCase()}</strong><br>
                ${message}
            `;
            
            results.appendChild(card);
            console.log(`[${timestamp}] ${message}`);
        }

        function clearCache() {
            // æ¸…é™¤å„ç¨®å¿«å–
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // æ¸…é™¤æœ¬åœ°å­˜å„²ä¸­çš„åŒæ­¥ç›¸é—œé …ç›®
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('temple-')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            log('å¿«å–å·²æ¸…é™¤ï¼Œå»ºè­°é‡æ–°æ•´ç†é é¢', 'success');
        }

        async function runTest() {
            document.getElementById('results').innerHTML = '';
            log('é–‹å§‹ç¨ç«‹æ¸¬è©¦...');

            // æ¸¬è©¦ 1: åŸºæœ¬ç’°å¢ƒ
            log('âœ“ ç€è¦½å™¨ï¼š' + navigator.userAgent.substring(0, 50) + '...');
            log('âœ“ åŸŸåï¼š' + window.location.hostname);
            log('âœ“ ç¶²è·¯ï¼š' + (navigator.onLine ? 'ç·šä¸Š' : 'é›¢ç·š'));

            // æ¸¬è©¦ 2: Supabase SDK
            try {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@supabase/supabase-js@2';
                document.head.appendChild(script);
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    setTimeout(reject, 10000); // 10ç§’è¶…æ™‚
                });
                
                if (typeof window.supabase !== 'undefined') {
                    log('âœ“ Supabase SDK è¼‰å…¥æˆåŠŸ', 'success');
                } else {
                    log('âœ— Supabase SDK è¼‰å…¥å¤±æ•—', 'error');
                    return;
                }
            } catch (error) {
                log('âœ— ç„¡æ³•è¼‰å…¥ Supabase SDK: ' + error.message, 'error');
                return;
            }

            // æ¸¬è©¦ 3: ç›´æ¥é€£æ¥ Supabase
            try {
                const supabaseUrl = 'https://nfncwofzfjdvyhdfjbzw.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mbmN3b2Z6ZmpkdnloZGZqYnp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MjM0MDcsImV4cCI6MjA3MzA5OTQwN30.ZyLtV91pG618utDhJhGJbZpbFPZ_IEx2mBPc7GVfkH4';
                
                const client = window.supabase.createClient(supabaseUrl, supabaseKey);
                log('âœ“ Supabase å®¢æˆ¶ç«¯å»ºç«‹æˆåŠŸ', 'success');

                // æ¸¬è©¦è³‡æ–™è¡¨é€£æ¥
                log('æ­£åœ¨æ¸¬è©¦è³‡æ–™è¡¨é€£æ¥...');
                const { data, error } = await client
                    .from('temple_data')
                    .select('count')
                    .limit(1);

                if (error) {
                    log(`âœ— è³‡æ–™è¡¨é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                    log(`éŒ¯èª¤è©³æƒ…: ${JSON.stringify(error)}`, 'warning');
                    
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        log('âš ï¸ å•é¡Œè¨ºæ–·ï¼šè³‡æ–™è¡¨ temple_data ä¸å­˜åœ¨ï¼', 'warning');
                        log('è§£æ±ºæ–¹æ¡ˆï¼šéœ€è¦åœ¨ Supabase æ§åˆ¶å°åŸ·è¡Œå»ºè¡¨ SQL', 'warning');
                    } else if (error.message.includes('permission') || error.message.includes('policy')) {
                        log('âš ï¸ å•é¡Œè¨ºæ–·ï¼šæ¬Šé™æ”¿ç­–å•é¡Œï¼', 'warning');
                        log('è§£æ±ºæ–¹æ¡ˆï¼šéœ€è¦è¨­å®šæ­£ç¢ºçš„ RLS æ”¿ç­–', 'warning');
                    }
                } else {
                    log('âœ“ è³‡æ–™è¡¨é€£æ¥æˆåŠŸï¼', 'success');
                    log(`æŸ¥è©¢çµæœ: ${JSON.stringify(data)}`, 'success');

                    // æ¸¬è©¦æ’å…¥æ•¸æ“š
                    try {
                        const testData = {
                            device_id: 'test_' + Date.now(),
                            data: { test: true, timestamp: Date.now() },
                            last_modified: Date.now(),
                            version: '2.0'
                        };

                        log('æ­£åœ¨æ¸¬è©¦æ•¸æ“šæ’å…¥...');
                        const { data: insertData, error: insertError } = await client
                            .from('temple_data')
                            .insert([testData]);

                        if (insertError) {
                            log(`âœ— æ•¸æ“šæ’å…¥å¤±æ•—: ${insertError.message}`, 'error');
                        } else {
                            log('âœ“ æ•¸æ“šæ’å…¥æˆåŠŸï¼é›²ç«¯åŒæ­¥åŠŸèƒ½æ­£å¸¸ï¼', 'success');
                            
                            // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                            await client
                                .from('temple_data')
                                .delete()
                                .eq('device_id', testData.device_id);
                            log('âœ“ æ¸¬è©¦æ•¸æ“šå·²æ¸…ç†', 'success');
                        }
                    } catch (insertError) {
                        log(`âœ— æ’å…¥æ¸¬è©¦å¤±æ•—: ${insertError.message}`, 'error');
                    }
                }
            } catch (error) {
                log(`âœ— Supabase æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }

            // æ¸¬è©¦å®Œæˆ
            log('=== æ¸¬è©¦å®Œæˆ ===');
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('é é¢è¼‰å…¥å®Œæˆï¼Œ5ç§’å¾Œè‡ªå‹•é–‹å§‹æ¸¬è©¦...');
                setTimeout(runTest, 5000);
            }, 1000);
        });
    </script>
</body>
</html>