<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netlify éƒ¨ç½²æ¸¬è©¦ - å»£æ¸…å®®è¨˜å¸³è»Ÿé«”</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .test-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #5a6fd8; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .online { background: #28a745; }
        .offline { background: #dc3545; }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ Netlify éƒ¨ç½²ç‹€æ…‹æª¢æŸ¥</h1>
        <p>é€™å€‹é é¢æœƒæª¢æŸ¥ä½ çš„ Netlify éƒ¨ç½²æ˜¯å¦æ­£ç¢ºé…ç½®äº† Supabase é€£æ¥ã€‚</p>
        
        <div class="test-card" id="env-check">
            <h3>ğŸ“‹ ç’°å¢ƒè®Šæ•¸æª¢æŸ¥</h3>
            <div id="env-results">æª¢æŸ¥ä¸­...</div>
        </div>
        
        <div class="test-card" id="supabase-check">
            <h3>ğŸ—„ï¸ Supabase é€£æ¥æ¸¬è©¦</h3>
            <div id="supabase-results">æª¢æŸ¥ä¸­...</div>
        </div>
        
        <div class="test-card" id="sync-test">
            <h3>â˜ï¸ åŒæ­¥åŠŸèƒ½æ¸¬è©¦</h3>
            <div id="sync-results">æª¢æŸ¥ä¸­...</div>
            <button class="btn" onclick="testSync()">ğŸ”„ æ¸¬è©¦åŒæ­¥</button>
        </div>
        
        <div class="test-card">
            <h3>ğŸ› ï¸ é™¤éŒ¯è³‡è¨Š</h3>
            <pre id="debug-info">è¼‰å…¥ä¸­...</pre>
        </div>
        
        <div class="test-card">
            <h3>ğŸ“– è§£æ±ºæ–¹æ¡ˆ</h3>
            <div id="solutions">
                <p>å¦‚æœç™¼ç¾å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š</p>
                <ol>
                    <li>Netlify ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¨­å®š</li>
                    <li>Supabase è³‡æ–™è¡¨æ˜¯å¦å·²å»ºç«‹</li>
                    <li>RLS æ”¿ç­–æ˜¯å¦æ­£ç¢ºé…ç½®</li>
                    <li>ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦è…³æœ¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="env-loader.js"></script>
    <script src="supabase-sync.js"></script>

    <script>
        function updateCard(cardId, className, content) {
            const card = document.getElementById(cardId);
            card.className = `test-card ${className}`;
            const results = card.querySelector('div[id$="results"]');
            if (results) results.innerHTML = content;
        }

        function log(message) {
            console.log(message);
            const debugInfo = document.getElementById('debug-info');
            debugInfo.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        // æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        function checkEnvironment() {
            log('æª¢æŸ¥ç’°å¢ƒè®Šæ•¸...');
            
            try {
                const envCheck = window.checkEnvironment ? window.checkEnvironment() : null;
                
                let content = '';
                if (envCheck) {
                    content += `<div><strong>ç‹€æ…‹:</strong> ${envCheck.ready ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}</div>`;
                    content += `<div><strong>URL:</strong> ${envCheck.config.supabaseUrl || 'æœªè¨­å®š'}</div>`;
                    content += `<div><strong>Key:</strong> ${envCheck.config.supabaseKey ? 'âœ… å·²è¨­å®š' : 'âŒ æœªè¨­å®š'}</div>`;
                    content += `<div><strong>ç’°å¢ƒ:</strong> ${envCheck.config.environment}</div>`;
                    
                    if (envCheck.warnings.length > 0) {
                        content += `<div><strong>è­¦å‘Š:</strong></div><ul>`;
                        envCheck.warnings.forEach(w => content += `<li>${w}</li>`);
                        content += `</ul>`;
                    }
                } else {
                    content = 'âŒ ç’°å¢ƒæª¢æŸ¥å·¥å…·è¼‰å…¥å¤±æ•—';
                }
                
                updateCard('env-check', envCheck && envCheck.ready ? 'success' : 'error', content);
                log(envCheck && envCheck.ready ? 'ç’°å¢ƒè®Šæ•¸æª¢æŸ¥é€šé' : 'ç’°å¢ƒè®Šæ•¸æª¢æŸ¥å¤±æ•—');
                
                return envCheck && envCheck.ready;
            } catch (error) {
                log('ç’°å¢ƒæª¢æŸ¥éŒ¯èª¤: ' + error.message);
                updateCard('env-check', 'error', 'âŒ ' + error.message);
                return false;
            }
        }

        // æ¸¬è©¦ Supabase é€£æ¥
        async function testSupabase() {
            log('æ¸¬è©¦ Supabase é€£æ¥...');
            
            try {
                if (!window.supabase) {
                    throw new Error('Supabase SDK æœªè¼‰å…¥');
                }

                const envConfig = window.getEnvConfig ? window.getEnvConfig() : null;
                if (!envConfig || !envConfig.supabaseUrl || !envConfig.supabaseKey) {
                    throw new Error('Supabase é…ç½®æœªè¼‰å…¥');
                }

                const client = window.supabase.createClient(envConfig.supabaseUrl, envConfig.supabaseKey);
                
                log('å˜—è©¦é€£æ¥åˆ°è³‡æ–™è¡¨...');
                const { data, error } = await client
                    .from('temple_data')
                    .select('count')
                    .limit(1);

                let content = '';
                if (error) {
                    content = `âŒ é€£æ¥å¤±æ•—<br>éŒ¯èª¤: ${error.message}<br>æç¤º: ${error.hint || 'æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨'}`;
                    updateCard('supabase-check', 'error', content);
                    log('Supabase é€£æ¥å¤±æ•—: ' + error.message);
                    return false;
                } else {
                    content = `âœ… é€£æ¥æˆåŠŸ<br>è³‡æ–™è¡¨: temple_data å¯å­˜å–<br>çµæœ: ${JSON.stringify(data)}`;
                    updateCard('supabase-check', 'success', content);
                    log('Supabase é€£æ¥æˆåŠŸ');
                    return true;
                }
            } catch (error) {
                log('Supabase æ¸¬è©¦éŒ¯èª¤: ' + error.message);
                updateCard('supabase-check', 'error', 'âŒ ' + error.message);
                return false;
            }
        }

        // æ¸¬è©¦åŒæ­¥åŠŸèƒ½
        async function testSync() {
            log('æ¸¬è©¦åŒæ­¥åŠŸèƒ½...');
            
            try {
                if (!window.supabaseSync && !window.cloudSync) {
                    throw new Error('åŒæ­¥æœå‹™æœªè¼‰å…¥');
                }

                const syncService = window.supabaseSync || window.cloudSync;
                const provider = syncService.supabase ? 'Supabase' : 'LocalStorage';
                
                log('é–‹å§‹æ¸¬è©¦åŒæ­¥...');
                updateCard('sync-test', 'warning', 'ğŸ”„ æ­£åœ¨æ¸¬è©¦åŒæ­¥...');
                
                const result = await syncService.syncToCloud();
                
                if (result.success) {
                    const content = `âœ… åŒæ­¥æ¸¬è©¦æˆåŠŸ<br>æä¾›å•†: ${result.provider || provider}<br>æ™‚é–“: ${result.syncTime}`;
                    updateCard('sync-test', 'success', content);
                    log('åŒæ­¥æ¸¬è©¦æˆåŠŸ');
                } else {
                    updateCard('sync-test', 'error', 'âŒ åŒæ­¥å¤±æ•—: ' + result.message);
                    log('åŒæ­¥æ¸¬è©¦å¤±æ•—: ' + result.message);
                }
            } catch (error) {
                log('åŒæ­¥æ¸¬è©¦éŒ¯èª¤: ' + error.message);
                updateCard('sync-test', 'error', 'âŒ ' + error.message);
            }
        }

        // åˆå§‹åŒ–æ¸¬è©¦
        document.addEventListener('DOMContentLoaded', async function() {
            log('é–‹å§‹ Netlify éƒ¨ç½²æ¸¬è©¦...');
            log('ç•¶å‰åŸŸå: ' + window.location.hostname);
            log('æ˜¯å¦ç‚º Netlify: ' + (window.location.hostname.includes('netlify')));
            
            // ç­‰å¾…è…³æœ¬è¼‰å…¥
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const envOk = checkEnvironment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (envOk) {
                const supabaseOk = await testSupabase();
                if (supabaseOk) {
                    updateCard('sync-test', 'success', 'âœ… æº–å‚™å°±ç·’ï¼Œå¯ä»¥æ¸¬è©¦åŒæ­¥');
                } else {
                    updateCard('sync-test', 'warning', 'âš ï¸ Supabase é€£æ¥å¤±æ•—ï¼ŒåŒæ­¥å¯èƒ½ç„¡æ³•æ­£å¸¸å·¥ä½œ');
                }
            } else {
                updateCard('sync-test', 'error', 'âŒ ç’°å¢ƒè®Šæ•¸æœªæ­£ç¢ºé…ç½®');
            }
            
            log('æ¸¬è©¦å®Œæˆ');
        });
    </script>
</body>
</html>