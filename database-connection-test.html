<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™åº«é€£æ¥æ¸¬è©¦ - å»£æ¸…å®®è¨˜å¸³è»Ÿé«”</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .success {
            background-color: #e8f5e8;
            border-color: #4CAF50;
        }
        .error {
            background-color: #ffeaea;
            border-color: #f44336;
        }
        .warning {
            background-color: #fff8e1;
            border-color: #ff9800;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #667eea;
            color: white;
        }
        button:hover {
            background-color: #5a6fd8;
        }
        pre {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .online { background-color: #4CAF50; }
        .offline { background-color: #f44336; }
        .unknown { background-color: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å»£æ¸…å®®è¨˜å¸³è»Ÿé«” - è³‡æ–™åº«é€£æ¥è¨ºæ–·</h1>
        
        <div class="test-section" id="environment-check">
            <h2>ğŸ“‹ ç’°å¢ƒè®Šæ•¸æª¢æŸ¥</h2>
            <div id="env-results">æª¢æŸ¥ä¸­...</div>
            <button onclick="checkEnvironment()">ğŸ”„ é‡æ–°æª¢æŸ¥ç’°å¢ƒ</button>
        </div>

        <div class="test-section" id="supabase-check">
            <h2>ğŸ—„ï¸ Supabase é€£æ¥æ¸¬è©¦</h2>
            <div id="supabase-results">æª¢æŸ¥ä¸­...</div>
            <button onclick="testSupabaseConnection()">ğŸ”— æ¸¬è©¦ Supabase é€£æ¥</button>
        </div>

        <div class="test-section" id="sync-service-check">
            <h2>â˜ï¸ åŒæ­¥æœå‹™æª¢æŸ¥</h2>
            <div id="sync-results">æª¢æŸ¥ä¸­...</div>
            <button onclick="testSyncService()">ğŸ”„ æ¸¬è©¦åŒæ­¥æœå‹™</button>
        </div>

        <div class="test-section" id="network-check">
            <h2>ğŸŒ ç¶²è·¯ç‹€æ…‹æª¢æŸ¥</h2>
            <div id="network-results">
                <span class="status-indicator" id="network-indicator"></span>
                <span id="network-status">æª¢æŸ¥ä¸­...</span>
            </div>
            <button onclick="checkNetworkStatus()">ğŸ“¶ æª¢æŸ¥ç¶²è·¯ç‹€æ…‹</button>
        </div>

        <div class="test-section" id="local-data-check">
            <h2>ğŸ’¾ æœ¬åœ°è³‡æ–™æª¢æŸ¥</h2>
            <div id="local-results">æª¢æŸ¥ä¸­...</div>
            <button onclick="checkLocalData()">ğŸ“Š æª¢æŸ¥æœ¬åœ°è³‡æ–™</button>
        </div>

        <div class="test-section" id="test-actions">
            <h2>ğŸ§ª æ¸¬è©¦æ“ä½œ</h2>
            <button onclick="performFullTest()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            <button onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™</button>
            <button onclick="generateTestData()">ğŸ² ç”Ÿæˆæ¸¬è©¦è³‡æ–™</button>
        </div>

        <div class="test-section" id="logs">
            <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
            <pre id="log-output"></pre>
            <button onclick="clearLogs()">ğŸ§¹ æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="env-loader.js"></script>
    <script src="supabase-sync.js"></script>

    <script>
        let logOutput = document.getElementById('log-output');

        function log(message) {
            const timestamp = new Date().toLocaleString('zh-TW');
            const logMessage = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logMessage;
            console.log(message);
        }

        function clearLogs() {
            logOutput.textContent = '';
        }

        function updateSectionStatus(sectionId, isSuccess, message) {
            const section = document.getElementById(sectionId);
            section.className = 'test-section ' + (isSuccess ? 'success' : 'error');
            section.querySelector('div:first-of-type').innerHTML = message;
        }

        // æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        function checkEnvironment() {
            log('é–‹å§‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸...');
            
            try {
                // æª¢æŸ¥å…¨åŸŸç’°å¢ƒè®Šæ•¸
                const envCheck = window.checkEnvironment ? window.checkEnvironment() : null;
                
                let results = '<h3>ç’°å¢ƒè®Šæ•¸æª¢æŸ¥çµæœï¼š</h3>';
                
                if (envCheck) {
                    results += `<p><strong>é…ç½®ç‹€æ…‹ï¼š</strong> ${envCheck.ready ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}</p>`;
                    results += `<p><strong>Supabase URLï¼š</strong> ${envCheck.config.supabaseUrl || 'æœªè¨­å®š'}</p>`;
                    results += `<p><strong>Supabase Keyï¼š</strong> ${envCheck.config.supabaseKey ? envCheck.config.supabaseKey.substring(0, 20) + '...' : 'æœªè¨­å®š'}</p>`;
                    results += `<p><strong>ç’°å¢ƒï¼š</strong> ${envCheck.config.environment || 'æœªçŸ¥'}</p>`;
                    
                    if (envCheck.warnings.length > 0) {
                        results += `<p><strong>è­¦å‘Šï¼š</strong></p><ul>`;
                        envCheck.warnings.forEach(warning => {
                            results += `<li>âš ï¸ ${warning}</li>`;
                        });
                        results += `</ul>`;
                    }
                } else {
                    results += `<p>âŒ ç„¡æ³•è¼‰å…¥ç’°å¢ƒæª¢æŸ¥å·¥å…·</p>`;
                }
                
                // æª¢æŸ¥ç¨‹åºç’°å¢ƒè®Šæ•¸
                results += `<h4>ç¨‹åºç’°å¢ƒè®Šæ•¸ï¼š</h4>`;
                results += `<p>NEXT_PUBLIC_SUPABASE_URL: ${process.env ? (process.env.NEXT_PUBLIC_SUPABASE_URL || 'æœªè¨­å®š') : 'ç„¡ process.env'}</p>`;
                results += `<p>NEXT_PUBLIC_SUPABASE_ANON_KEY: ${process.env ? (process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ? process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY.substring(0, 20) + '...' : 'æœªè¨­å®š') : 'ç„¡ process.env'}</p>`;
                
                updateSectionStatus('environment-check', envCheck && envCheck.ready, results);
                log(envCheck && envCheck.ready ? 'ç’°å¢ƒè®Šæ•¸æª¢æŸ¥é€šé' : 'ç’°å¢ƒè®Šæ•¸æª¢æŸ¥å¤±æ•—');
                
            } catch (error) {
                const errorMsg = `ç’°å¢ƒæª¢æŸ¥å¤±æ•—ï¼š${error.message}`;
                updateSectionStatus('environment-check', false, `<p>âŒ ${errorMsg}</p>`);
                log(errorMsg);
            }
        }

        // æ¸¬è©¦ Supabase é€£æ¥
        async function testSupabaseConnection() {
            log('é–‹å§‹æ¸¬è©¦ Supabase é€£æ¥...');
            
            try {
                // æª¢æŸ¥ Supabase æ˜¯å¦å·²è¼‰å…¥
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK æœªè¼‰å…¥');
                }

                // å¾ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
                const envConfig = window.getEnvConfig ? window.getEnvConfig() : null;
                if (!envConfig || !envConfig.supabaseUrl || !envConfig.supabaseKey) {
                    throw new Error('Supabase é…ç½®æœªæ­£ç¢ºè¼‰å…¥');
                }

                // å‰µå»º Supabase å®¢æˆ¶ç«¯
                const supabaseClient = window.supabase.createClient(
                    envConfig.supabaseUrl,
                    envConfig.supabaseKey
                );

                // æ¸¬è©¦é€£æ¥ - å˜—è©¦æŸ¥è©¢è³‡æ–™è¡¨
                log('æ­£åœ¨æ¸¬è©¦è³‡æ–™è¡¨é€£æ¥...');
                const { data, error } = await supabaseClient
                    .from('temple_data')
                    .select('count')
                    .limit(1);

                let results = '<h3>Supabase é€£æ¥æ¸¬è©¦çµæœï¼š</h3>';
                
                if (error) {
                    results += `<p>âŒ é€£æ¥å¤±æ•—ï¼š${error.message}</p>`;
                    results += `<p>éŒ¯èª¤è©³æƒ…ï¼š${error.details || 'ç„¡è©³æƒ…'}</p>`;
                    results += `<p>æç¤ºï¼š${error.hint || 'æª¢æŸ¥è³‡æ–™è¡¨æ˜¯å¦å­˜åœ¨ä¸”æ¬Šé™è¨­å®šæ­£ç¢º'}</p>`;
                    updateSectionStatus('supabase-check', false, results);
                    log(`Supabase é€£æ¥å¤±æ•—ï¼š${error.message}`);
                } else {
                    results += `<p>âœ… é€£æ¥æˆåŠŸï¼</p>`;
                    results += `<p>è³‡æ–™è¡¨ï¼štemple_data å¯å­˜å–</p>`;
                    results += `<p>æŸ¥è©¢çµæœï¼š${JSON.stringify(data)}</p>`;
                    updateSectionStatus('supabase-check', true, results);
                    log('Supabase é€£æ¥æ¸¬è©¦æˆåŠŸ');
                }
                
            } catch (error) {
                const errorMsg = `Supabase é€£æ¥æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
                updateSectionStatus('supabase-check', false, `<p>âŒ ${errorMsg}</p>`);
                log(errorMsg);
            }
        }

        // æ¸¬è©¦åŒæ­¥æœå‹™
        async function testSyncService() {
            log('é–‹å§‹æ¸¬è©¦åŒæ­¥æœå‹™...');
            
            try {
                let results = '<h3>åŒæ­¥æœå‹™æ¸¬è©¦çµæœï¼š</h3>';
                
                // æª¢æŸ¥åŒæ­¥æœå‹™æ˜¯å¦è¼‰å…¥
                if (typeof window.supabaseSync !== 'undefined') {
                    results += `<p>âœ… Supabase åŒæ­¥æœå‹™å·²è¼‰å…¥</p>`;
                    
                    // ç²å–åŒæ­¥ç‹€æ…‹
                    const status = window.supabaseSync.getSyncStatus();
                    results += `<p>è¨­å‚™ IDï¼š${status.deviceId}</p>`;
                    results += `<p>ç¶²è·¯ç‹€æ…‹ï¼š${status.isOnline ? 'âœ… ç·šä¸Š' : 'âŒ é›¢ç·š'}</p>`;
                    results += `<p>æœ€å¾ŒåŒæ­¥ï¼š${status.lastSyncTime}</p>`;
                    results += `<p>æä¾›å•†ï¼š${status.provider}</p>`;
                    results += `<p>åŒæ­¥é€²è¡Œä¸­ï¼š${status.syncInProgress ? 'æ˜¯' : 'å¦'}</p>`;
                    
                } else if (typeof window.cloudSync !== 'undefined') {
                    results += `<p>âš ï¸ ä½¿ç”¨å‚³çµ±é›²ç«¯åŒæ­¥æœå‹™</p>`;
                } else {
                    results += `<p>âŒ æ²’æœ‰å¯ç”¨çš„åŒæ­¥æœå‹™</p>`;
                }
                
                updateSectionStatus('sync-service-check', typeof window.supabaseSync !== 'undefined', results);
                log('åŒæ­¥æœå‹™æª¢æŸ¥å®Œæˆ');
                
            } catch (error) {
                const errorMsg = `åŒæ­¥æœå‹™æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
                updateSectionStatus('sync-service-check', false, `<p>âŒ ${errorMsg}</p>`);
                log(errorMsg);
            }
        }

        // æª¢æŸ¥ç¶²è·¯ç‹€æ…‹
        function checkNetworkStatus() {
            log('æª¢æŸ¥ç¶²è·¯ç‹€æ…‹...');
            
            const isOnline = navigator.onLine;
            const indicator = document.getElementById('network-indicator');
            const status = document.getElementById('network-status');
            
            if (isOnline) {
                indicator.className = 'status-indicator online';
                status.textContent = 'ç·šä¸Š';
                updateSectionStatus('network-check', true, `
                    <span class="status-indicator online"></span>
                    <span>âœ… ç¶²è·¯é€£æ¥æ­£å¸¸</span>
                `);
                log('ç¶²è·¯ç‹€æ…‹ï¼šç·šä¸Š');
            } else {
                indicator.className = 'status-indicator offline';
                status.textContent = 'é›¢ç·š';
                updateSectionStatus('network-check', false, `
                    <span class="status-indicator offline"></span>
                    <span>âŒ ç¶²è·¯é€£æ¥ä¸­æ–·</span>
                `);
                log('ç¶²è·¯ç‹€æ…‹ï¼šé›¢ç·š');
            }
        }

        // æª¢æŸ¥æœ¬åœ°è³‡æ–™
        function checkLocalData() {
            log('æª¢æŸ¥æœ¬åœ°è³‡æ–™...');
            
            try {
                const records = JSON.parse(localStorage.getItem('temple-records') || '[]');
                const believers = JSON.parse(localStorage.getItem('temple-believers') || '[]');
                const reminders = JSON.parse(localStorage.getItem('temple-reminders') || '[]');
                const inventory = JSON.parse(localStorage.getItem('temple-inventory') || '[]');
                
                const results = `
                    <h3>æœ¬åœ°è³‡æ–™çµ±è¨ˆï¼š</h3>
                    <p>ğŸ“Š è¨˜å¸³è¨˜éŒ„ï¼š${records.length} ç­†</p>
                    <p>ğŸ‘¥ ä¿¡çœ¾è³‡æ–™ï¼š${believers.length} ç­†</p>
                    <p>â° æé†’äº‹é …ï¼š${reminders.length} ç­†</p>
                    <p>ğŸ“¦ åº«å­˜é …ç›®ï¼š${inventory.length} ç­†</p>
                    <p>ğŸ’¾ ç¸½è³‡æ–™é‡ï¼š${JSON.stringify({records, believers, reminders, inventory}).length} å­—å…ƒ</p>
                `;
                
                updateSectionStatus('local-data-check', true, results);
                log(`æœ¬åœ°è³‡æ–™æª¢æŸ¥å®Œæˆï¼šè¨˜éŒ„${records.length}ç­†ï¼Œä¿¡çœ¾${believers.length}ç­†`);
                
            } catch (error) {
                const errorMsg = `æœ¬åœ°è³‡æ–™æª¢æŸ¥å¤±æ•—ï¼š${error.message}`;
                updateSectionStatus('local-data-check', false, `<p>âŒ ${errorMsg}</p>`);
                log(errorMsg);
            }
        }

        // ç”Ÿæˆæ¸¬è©¦è³‡æ–™
        function generateTestData() {
            log('ç”Ÿæˆæ¸¬è©¦è³‡æ–™...');
            
            const testRecord = {
                id: Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                type: 'æ”¶å…¥',
                category: 'é¦™æ²¹éŒ¢',
                amount: Math.floor(Math.random() * 10000) + 100,
                description: 'æ¸¬è©¦è³‡æ–™ - è‡ªå‹•ç”Ÿæˆ',
                timestamp: Date.now()
            };
            
            const existingRecords = JSON.parse(localStorage.getItem('temple-records') || '[]');
            existingRecords.push(testRecord);
            localStorage.setItem('temple-records', JSON.stringify(existingRecords));
            localStorage.setItem('temple-last-modified', Date.now().toString());
            
            log(`å·²ç”Ÿæˆæ¸¬è©¦è¨˜éŒ„ï¼š${testRecord.category} ${testRecord.amount}å…ƒ`);
            checkLocalData(); // é‡æ–°æª¢æŸ¥æœ¬åœ°è³‡æ–™
        }

        // æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                localStorage.removeItem('temple-records');
                localStorage.removeItem('temple-believers');
                localStorage.removeItem('temple-reminders');
                localStorage.removeItem('temple-inventory');
                localStorage.removeItem('temple-last-modified');
                log('å·²æ¸…é™¤æ‰€æœ‰æ¸¬è©¦è³‡æ–™');
                checkLocalData(); // é‡æ–°æª¢æŸ¥æœ¬åœ°è³‡æ–™
            }
        }

        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦
        async function performFullTest() {
            log('=== é–‹å§‹åŸ·è¡Œå®Œæ•´æ¸¬è©¦ ===');
            
            checkEnvironment();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSupabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            testSyncService();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkNetworkStatus();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkLocalData();
            
            log('=== å®Œæ•´æ¸¬è©¦åŸ·è¡Œå®Œæˆ ===');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('è³‡æ–™åº«é€£æ¥æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            
            // ç›£è½ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
            window.addEventListener('online', () => {
                log('ç¶²è·¯ç‹€æ…‹è®Šæ›´ï¼šå·²é€£æ¥');
                checkNetworkStatus();
            });
            
            window.addEventListener('offline', () => {
                log('ç¶²è·¯ç‹€æ…‹è®Šæ›´ï¼šå·²æ–·ç·š');
                checkNetworkStatus();
            });
            
            // è‡ªå‹•åŸ·è¡Œåˆå§‹æª¢æŸ¥
            setTimeout(performFullTest, 1000);
        });
    </script>
</body>
</html>