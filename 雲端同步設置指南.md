# 🚀 廣清宮記帳軟體 - 雲端同步設置指南

## 📋 問題診斷結果

經過完整分析，發現以下關鍵問題：

### ❌ **主要問題**
1. **資料庫表不存在** - Supabase 中缺少 `temple_data` 資料表
2. **同步服務配置** - 需要使用最新的同步服務版本
3. **權限設定** - RLS 政策可能配置不當

## 🛠️ **完整解決方案**

### **步驟 1: 在 Supabase 中建立資料表** ⭐
**這是最重要的步驟！**

1. 登入您的 Supabase 控制台：https://supabase.com/dashboard
2. 選擇您的專案：`nfncwofzfjdvyhdfjbzw`
3. 點擊左側選單的「SQL Editor」
4. 複製並執行以下完整的 SQL 腳本：

```sql
-- 請在 Supabase SQL Editor 中執行此完整腳本
-- 這會建立所有必要的資料表、索引、權限和政策

-- 1. 建立主要資料表
CREATE TABLE IF NOT EXISTS temple_data (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    device_id TEXT NOT NULL,
    data JSONB NOT NULL,
    last_modified BIGINT NOT NULL,
    version TEXT DEFAULT '3.0',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. 建立索引提升查詢效能
CREATE INDEX IF NOT EXISTS idx_temple_data_device_id ON temple_data(device_id);
CREATE INDEX IF NOT EXISTS idx_temple_data_updated_at ON temple_data(updated_at DESC);
CREATE INDEX IF NOT EXISTS idx_temple_data_last_modified ON temple_data(last_modified DESC);

-- 3. 建立觸發器自動更新 updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 移除舊的觸發器（如果存在）
DROP TRIGGER IF EXISTS update_temple_data_updated_at ON temple_data;

-- 建立新的觸發器
CREATE TRIGGER update_temple_data_updated_at 
    BEFORE UPDATE ON temple_data 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- 4. 啟用 Row Level Security (RLS)
ALTER TABLE temple_data ENABLE ROW LEVEL SECURITY;

-- 5. 移除所有現有的 RLS 政策
DROP POLICY IF EXISTS "Allow all operations for all users" ON temple_data;
DROP POLICY IF EXISTS "Allow all operations for temple_data" ON temple_data;
DROP POLICY IF EXISTS "Enable all operations for all users" ON temple_data;

-- 6. 建立新的 RLS 政策（允許匿名用戶進行所有操作）
CREATE POLICY "Enable all operations for authenticated and anonymous users" 
    ON temple_data 
    FOR ALL 
    USING (true) 
    WITH CHECK (true);

-- 7. 確保匿名用戶有足夠權限
GRANT ALL ON temple_data TO anon;
GRANT ALL ON temple_data TO authenticated;

-- 8. 插入測試資料以驗證設置
INSERT INTO temple_data (device_id, data, last_modified, version) 
VALUES (
    'setup_test_' || EXTRACT(EPOCH FROM NOW()),
    '{"setup_test": true, "message": "Supabase 設定成功", "timestamp": ' || EXTRACT(EPOCH FROM NOW()) * 1000 || '}',
    EXTRACT(EPOCH FROM NOW()) * 1000,
    '3.0'
) ON CONFLICT DO NOTHING;

-- 9. 驗證設置結果
SELECT 
    'Supabase 設定完成!' as status,
    COUNT(*) as total_records,
    MAX(created_at) as latest_record_time
FROM temple_data;
```

5. 執行後應該會看到類似這樣的結果：
   ```
   status: "Supabase 設定完成!"
   total_records: 1
   latest_record_time: "2025-01-13 ..."
   ```

### **步驟 2: 執行完整測試** 🧪

1. 打開測試工具：`test-cloud-sync-complete.html`
2. 測試工具會自動執行 6 個步驟的完整檢測
3. 確認所有測試項目都顯示 ✅ 成功

### **步驟 3: 在主應用中測試同步** 📱

1. 打開主應用：`index-enhanced.html`
2. 進入「雲端同步」頁面
3. 點擊「立即同步」按鈕
4. 應該會看到成功提示

## 🔧 **檔案清單**

### **新建立的檔案：**
- ✅ `supabase-setup-optimized.sql` - 優化的資料庫建立腳本
- ✅ `supabase-sync-final.js` - 最終版同步服務（已整合到主應用）
- ✅ `test-cloud-sync-complete.html` - 完整測試工具
- ✅ `雲端同步設置指南.md` - 本指南文件

### **已修改的檔案：**
- ✅ `index-enhanced.html` - 更新為使用最新同步服務

## 📊 **測試功能**

### **完整測試工具功能：**
- 🔍 **完整診斷** - 6 步驟完整檢測
- 📤 **測試上傳** - 測試數據上傳到雲端
- 📥 **測試下載** - 測試從雲端下載數據
- ⚡ **壓力測試** - 測試系統穩定性
- 📈 **即時統計** - 顯示成功率和平均時間

### **新同步服務功能：**
- 🔄 **智能重試** - 失敗時自動重試 3 次
- ⚡ **超時控制** - 30 秒超時保護
- 🛡️ **衝突解決** - 智能處理數據衝突
- 📱 **離線支援** - 網路斷線時降級到本地同步
- 🔒 **數據備份** - 自動建立本地備份

## ⚠️ **常見問題解決**

### **問題 1: 資料表不存在**
```
錯誤：relation "temple_data" does not exist
解決：執行步驟 1 的 SQL 腳本
```

### **問題 2: 權限被拒絕**
```
錯誤：permission denied for table temple_data
解決：檢查 RLS 政策，確保匿名用戶有權限
```

### **問題 3: 連接超時**
```
錯誤：連接超時
解決：檢查網路連接，或稍後再試
```

### **問題 4: SDK 載入失敗**
```
錯誤：Supabase SDK 未載入
解決：檢查網路連接，確保能存取 unpkg.com
```

## 🎯 **驗證步驟**

執行以下檢查確認一切正常：

1. ✅ **資料庫檢查**：在 Supabase 控制台看到 `temple_data` 資料表
2. ✅ **測試工具**：`test-cloud-sync-complete.html` 所有測試通過
3. ✅ **主應用**：雲端同步功能正常工作
4. ✅ **數據同步**：能成功上傳和下載數據
5. ✅ **多設備**：不同設備間能正常同步

## 📞 **技術支援**

如果遇到問題：

1. **查看測試結果** - 使用 `test-cloud-sync-complete.html` 診斷
2. **檢查瀏覽器控制台** - F12 → Console 查看錯誤訊息
3. **確認 Supabase 設置** - 登入控制台檢查資料表和權限
4. **網路連接測試** - 確保能連接到 Supabase

## 🏆 **完成確認**

完成設置後，您應該能夠：

- ✅ 在主應用中成功使用雲端同步
- ✅ 上傳本地數據到雲端
- ✅ 從雲端下載數據到本地
- ✅ 在不同設備間同步數據
- ✅ 使用 QR Code 進行設備間同步

---

**🎉 恭喜！您的雲端同步功能現在已經完全可用了！**

© 2025 廣清宮開發團隊